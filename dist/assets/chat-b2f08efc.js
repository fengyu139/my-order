import{J as Be,K as Ae,o as p,d as g,l as N,n as te,e as f,as as Me,P as re,Y as Re,a4 as je,c as Z,_ as we,b as xe,at as Fe,h as le,j as ce,t as C,H as O,k as P,f as Ie,F as ee,C as ke,L as He,i as Ce,r as x,au as Ve,av as Ue,aw as We,ax as Se,ab as Ye,m as Ge,ac as Je,ad as Ke,ay as Xe,a as ue,az as qe,N as Qe,aA as Ze,w as et,p as de,s as w,v as m,a9 as tt,ai as at,A as H,aB as st,x as pe,I as nt,z as ot,y as B,V as it,W as rt,a2 as me,aC as lt,X as ct}from"./index-9136c8a7.js";import{I as ut}from"./index-ea9c78a1.js";import{B as fe}from"./index-bc0883c4.js";import{U as dt}from"./index-cd562f1d.js";import{g as ge,C as pt,N as mt,w as ft,s as gt}from"./index-93accbbe.js";import"./Checked-081e5204.js";import"./index-29892cda-1b4cc563.js";import"./index-7a7385e4-c33637fa.js";import"./raf-729dad54-28ee5fbb.js";const vt=Ae("horizontal-n"),ht=f("path",{d:"M977.455 124.121H46.545C21.721 124.121 0 102.4 0 77.576S21.721 31.03 46.545 31.03h930.91c24.824 0 46.545 21.722 46.545 46.546s-21.721 46.545-46.545 46.545zm0 868.849H46.545C21.721 992.97 0 971.248 0 946.424s21.721-46.545 46.545-46.545h930.91c24.824 0 46.545 21.721 46.545 46.545s-21.721 46.546-46.545 46.546zm0-434.425H356.848c-24.824 0-46.545-21.72-46.545-46.545s21.721-46.545 46.545-46.545h620.607c24.824 0 46.545 21.72 46.545 46.545s-21.721 46.545-46.545 46.545z",fill:"currentColor","fill-opacity":"0.9"},null,-1),_t=[ht];function yt(e,t,n,h,r,_){return p(),g("svg",{class:N(e.classes),style:te(e.style),xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024",role:"presentation"},_t,6)}const bt=Be(vt,[["render",yt]]),wt=e=>e,xt=wt(Me);var It=Object.defineProperty,kt=Object.defineProperties,Ct=Object.getOwnPropertyDescriptors,ve=Object.getOwnPropertySymbols,St=Object.prototype.hasOwnProperty,$t=Object.prototype.propertyIsEnumerable,he=(e,t,n)=>t in e?It(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Tt=(e,t)=>{for(var n in t||(t={}))St.call(t,n)&&he(e,n,t[n]);if(ve)for(var n of ve(t))$t.call(t,n)&&he(e,n,t[n]);return e},Et=(e,t)=>kt(e,Ct(t));const{componentName:Ot,create:Nt}=xe("action-sheet"),Lt=Nt({components:{[re.name]:re,Loading:Re},props:Et(Tt({},Fe),{cancelTxt:{type:String,default:""},optionTag:{type:String,default:"name"},optionSubTag:{type:String,default:"subname"},chooseTagValue:{type:String,default:""},title:{type:String,default:""},color:{type:String,default:"#ee0a24"},description:{type:String,default:""},menuItems:{type:Array,default:()=>[]},closeAbled:{type:Boolean,default:!0}}),emits:["cancel","close","choose","update:visible"],setup(e,{emit:t}){const n=!!je().default,h=Z(()=>({[Ot]:!0}));return{slotDefault:n,isHighlight:a=>e.chooseTagValue&&e.chooseTagValue===a[e.optionTag]?e.color:"",cancelActionSheet:()=>{t("cancel"),t("update:visible",!1)},chooseItem:(a,v)=>{!a.disable&&!a.loading&&(t("choose",a,v),t("update:visible",!1))},close:a=>{e.closeAbled&&(t("close",a),t("update:visible",!1))},classes:h}}}),zt={key:0,class:"nut-action-sheet__title"},Pt={key:1},Dt={key:0,class:"nut-action-sheet__item nut-action-sheet__desc"},Bt={key:1,class:"nut-action-sheet__menu"},At=["onClick"],Mt={key:1},Rt={class:"nut-action-sheet__subdesc"};function jt(e,t,n,h,r,_){const l=le("Loading"),d=le("nut-popup");return p(),ce(d,{visible:e.visible,position:"bottom",round:"","close-on-click-overlay":e.closeAbled,"lock-scroll":e.lockScroll,onClickOverlay:e.close},{default:C(()=>[f("view",{class:N(e.classes)},[e.title?(p(),g("view",zt,O(e.title),1)):P("",!0),Ie(e.$slots,"default"),e.slotDefault?P("",!0):(p(),g("view",Pt,[e.description?(p(),g("view",Dt,O(e.description),1)):P("",!0),e.menuItems.length?(p(),g("view",Bt,[(p(!0),g(ee,null,ke(e.menuItems,(a,v)=>(p(),g("view",{key:v,class:N(["nut-action-sheet__item",{"nut-action-sheet__item--disabled":a.disable,"nut-action-sheet__item--loading":a.loading}]),style:te({color:e.isHighlight(a)||a.color}),onClick:I=>e.chooseItem(a,v)},[a.loading?(p(),ce(l,{key:0,name:"loading"})):(p(),g("view",Mt,O(a[e.optionTag]),1)),f("view",Rt,O(a[e.optionSubTag]),1)],14,At))),128))])):P("",!0),e.cancelTxt?(p(),g("view",{key:2,class:"nut-action-sheet__cancel",onClick:t[0]||(t[0]=(...a)=>e.cancelActionSheet&&e.cancelActionSheet(...a))},O(e.cancelTxt),1)):P("",!0)]))],2)]),_:3},8,["visible","close-on-click-overlay","lock-scroll","onClickOverlay"])}const Ft=we(Lt,[["render",jt]]),Ht=e=>e,Vt=Ht(Ft),{create:Ut}=xe("avatar"),Wt=Ut({props:{size:{type:[String,Number],default:"normal"},shape:{type:String,default:"round"},bgColor:{type:String,default:"#eee"},color:{type:String,default:"#666"}},setup(e){const{size:t,shape:n,bgColor:h,color:r}=He(e),_=["large","normal","small"],l=Ce("avatarGroup",null),d=x(null),a=Z(()=>{var I,b;return{["nut-avatar"]:!0,[`nut-avatar-${t.value||((I=l==null?void 0:l.props)==null?void 0:I.size)||"normal"}`]:!0,[`nut-avatar-${n.value||((b=l==null?void 0:l.props)==null?void 0:b.shape)||"round"}`]:!0}}),v=Z(()=>{var I,b;return{width:t.value in _?"":`${t.value}px`,height:t.value in _?"":`${t.value}px`,backgroundColor:`${h.value}`,color:`${r.value}`,marginLeft:(I=l==null?void 0:l.props)!=null&&I.span?`${(b=l==null?void 0:l.props)==null?void 0:b.span}px`:""}});return{classes:a,styles:v,avatarRef:d}}});function Yt(e,t,n,h,r,_){return p(),g("view",{ref:"avatarRef",style:te(e.styles),class:N(e.classes)},[Ie(e.$slots,"default")],6)}const Gt=we(Wt,[["render",Yt]]),Jt=e=>e,Kt=Jt(Gt);const Xt="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ccircle cx='18' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='.67' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3Ccircle cx='12' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='.33' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3Ccircle cx='6' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='0' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3C!-- 1701252868811 --%3E%3C/svg%3E",$e=Xt,qt=""+new URL("chatBg-91517f37.jpg",import.meta.url).href;var Qt=Ve,Zt=function(){return Qt.Date.now()},ea=Zt,ta=/\s/;function aa(e){for(var t=e.length;t--&&ta.test(e.charAt(t)););return t}var sa=aa,na=sa,oa=/^\s+/;function ia(e){return e&&e.slice(0,na(e)+1).replace(oa,"")}var ra=ia,la=Ue,ca=We,ua="[object Symbol]";function da(e){return typeof e=="symbol"||ca(e)&&la(e)==ua}var pa=da,ma=ra,_e=Se,fa=pa,ye=0/0,ga=/^[-+]0x[0-9a-f]+$/i,va=/^0b[01]+$/i,ha=/^0o[0-7]+$/i,_a=parseInt;function ya(e){if(typeof e=="number")return e;if(fa(e))return ye;if(_e(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=_e(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=ma(e);var n=va.test(e);return n||ha.test(e)?_a(e.slice(2),n?2:8):ga.test(e)?ye:+e}var ba=ya,wa=Se,Q=ea,be=ba,xa="Expected a function",Ia=Math.max,ka=Math.min;function Ca(e,t,n){var h,r,_,l,d,a,v=0,I=!1,b=!1,L=!0;if(typeof e!="function")throw new TypeError(xa);t=be(t)||0,wa(n)&&(I=!!n.leading,b="maxWait"in n,_=b?Ia(be(n.maxWait)||0,t):_,L="trailing"in n?!!n.trailing:L);function D(c){var k=h,S=r;return h=r=void 0,v=c,l=e.apply(S,k),l}function U(c){return v=c,d=setTimeout(z,t),I?D(c):l}function W(c){var k=c-a,S=c-v,R=t-k;return b?ka(R,_-S):R}function A(c){var k=c-a,S=c-v;return a===void 0||k>=t||k<0||b&&S>=_}function z(){var c=Q();if(A(c))return M(c);d=setTimeout(z,W(c))}function M(c){return d=void 0,L&&h?D(c):(h=r=void 0,l)}function Y(){d!==void 0&&clearTimeout(d),v=0,h=a=r=d=void 0}function G(){return d===void 0?l:M(Q())}function E(){var c=Q(),k=A(c);if(h=arguments,r=this,a=c,k){if(d===void 0)return U(a);if(b)return clearTimeout(d),d=setTimeout(z,t),D(a)}return d===void 0&&(d=setTimeout(z,t)),l}return E.cancel=Y,E.flush=G,E}var Sa=Ca;const $a=Ye(Sa);var V=ge.registerPlugin(pt)||ge;V.core.Tween;const ae=e=>(it("data-v-778dfe50"),e=e(),rt(),e),Ta={class:"flex items-center"},Ea=ae(()=>f("span",null," 刷新",-1)),Oa=["onClick"],Na=["src"],La={class:"text-[12px]"},za=["data-id"],Pa=["innerHTML"],Da={key:0,class:"absolute left-[-20px] top-[10px] text-[#858585]"},Ba={class:"relative"},Aa={class:"text-red-500 absolute top-[-10px] text-[12px] left-[4px] z-10 bg-white flex"},Ma=ae(()=>f("img",{src:$e,alt:"",srcset:""},null,-1)),Ra={class:"flex items-center"},ja=ae(()=>f("div",{class:"wrapper"},[f("img",{src:qt,class:"w-full",alt:"",srcset:""})],-1)),Fa=Ge({__name:"chat",setup(e){const t=Je("chatId","");t.value=Ke().query.id;const n=Ce("socket");console.log($e);const{copy:h}=Xe({legacy:!0}),r=ue({msg:"",name:t.value=="1"?"小扈":"老胡",chatId:t.value,picImg:"",type:"text",msgId:""}),_=qe(),l=x(null),d=x(null),a=x([]),v=x(null),I=()=>{if(r.msg=="")return B.fail("请输入内容");r.type="text",r.msgId=new Date().getTime().toString(),n.emit("chat",r),a.value.push(JSON.parse(JSON.stringify(r))),r.msg="",b(!1)},b=s=>{nt(()=>{var y,$;V.to(l.value,{scrollTop:(y=l.value)==null?void 0:y.scrollHeight,duration:.3});let o=v.value[(($=v.value)==null?void 0:$.length)-1],u=s?-100:100;V.fromTo(o,{opacity:0,x:u},{opacity:1,duration:.3,x:0}),s&&Pe.observe(o)})};n.on("chat",s=>{a.value.push(s),b(!0),_.value!="visible"&&t.value=="2"&&alert("有消息了")}),n.on("chatEnter",s=>{se.value=s.entering}),n.on("chatDelete",s=>{let o=a.value.findIndex(u=>u.msgId==s);a.value.splice(o,1)}),n.on("read",s=>{s.forEach(o=>{let u=a.value.findIndex(y=>y.msgId==(o.msgId||o));a.value[u].isRead=!0})});const L=s=>new Promise(o=>{const u=new FileReader;u.onloadend=y=>o(y.target.result),u.readAsDataURL(s)}),D=(s,o,u)=>new Promise(y=>s.toBlob($=>y($),o,u)),U=s=>new Promise(o=>{const u=new Image;u.onload=()=>o(u),u.src=s}),W=s=>{r.picImg=JSON.parse(s.responseText).data,r.msgId=new Date().getTime().toString(),n.emit("chat",r),d.value.clearUploadQueue(),r.picImg=""},A=s=>{B.fail(s)},z=async s=>{if(M(s[0])){r.type="img";let u=s[0].name;const y=document.createElement("canvas"),$=y.getContext("2d"),X=await L(s[0]),T=await U(X);y.width=T.width,y.height=T.height,$.clearRect(0,0,T.width,T.height),$.drawImage(T,0,0,T.width,T.height);let q=await D(y,"image/jpeg",.5);return[await new File([q],u)]}r.type="file";let o=await new File([s[0]],s[0].name);return console.log(o),[o]};function M(s){return s.type.startsWith("image/")}const Y=s=>{const o=document.createElement("a");o.href=s,o.download=s.slice(s.lastIndexOf("/"),s.length),o.click()};Qe(()=>{});const G=x(10),E=x(1),c=async()=>{let s=await ot.get("/chatList",{params:{pageSize:G.value,pageNum:E.value}});a.value.unshift(...s.data),k.value=!1,E.value==1&&setTimeout(()=>{V.to(l.value,{scrollTop:l.value.scrollHeight,duration:.5});let o=a.value.filter(u=>u.chatId!=t.value);o.length>0&&n.emit("read",o)},800),s.data.length==0&&Oe()};c();const k=x(!1),{y:S,directions:R}=Ze(l,{offset:{top:30,bottom:30,right:30,left:30}}),Te=$a(async()=>{E.value++,await c(),S.value=400},500),Ee=()=>{E.value=1,a.value=[],c()},Oe=et(S,()=>{S.value<11&&R.top&&Te()}),J=x(!1),se=x(!1);let ne=null;const Ne=()=>{clearTimeout(ne),J.value||(J.value=!0,n.emit("chatEnter",{entering:!0})),ne=setTimeout(()=>{J.value=!1,n.emit("chatEnter",{entering:!1})},1500)},j=x(!1),F=x(!1),Le=ue([{name:"删除当条消息",type:"delete"},{name:"复制消息",type:"copy"}]),K=x(""),ze=async s=>{if(s.type=="delete")n.emit("chatDelete",K.value),B.success("删除成功");else{let o=a.value.find(u=>u.msgId==K.value);console.log(o);try{await h(o.msg||o.picImg),B.success("复制成功")}catch{B.fail("复制失败")}}},Pe=new IntersectionObserver(s=>{s.forEach(o=>{o.isIntersecting&&(console.log(de().format("YYYY-MM-DD HH:mm:ss")),console.log(_.value),_.value=="visible"&&n.emit("read",[o.target.dataset.id]))})},{});return(s,o)=>{const u=mt,y=Kt,$=fe,X=dt,T=fe,q=ut,oe=xt,De=Vt;return p(),g(ee,null,[w(u,{title:"小小聊天室",fixed:"",class:"bg-gray-300",onClickRight:o[0]||(o[0]=i=>j.value=!0),onClickBack:Ee},{left:C(()=>[f("div",Ta,[Ea,w(m(ft),{width:"18px"})])]),right:C(()=>[w(m(bt),{class:"right",width:"18px"})]),_:1}),f("div",{style:{height:"calc(100vh - 96px)"},class:"overflow-y-auto overflow-x-hidden",ref_key:"chatBox",ref:l},[f("ul",null,[(p(!0),g(ee,null,ke(m(a),i=>(p(),g("li",{class:N(["flex mt-[10px] mb-[24px]",{"flex-row-reverse":i.chatId==m(t)}]),key:i.msgId},[w(y,{onClick:ie=>{F.value=!0,K.value=i.msgId},class:"z-20 relative",color:"rgb(245, 106, 0)","bg-color":"rgb(253, 227, 207)"},{default:C(()=>[H(O(i.name),1)]),_:2},1032,["onClick"]),i.type=="img"?(p(),g("div",{key:0,onClick:ie=>m(gt)({show:!0,images:[{src:i.picImg}]}),class:"mx-[12px]"},[f("img",{src:i.picImg,alt:"",srcset:""},null,8,Na)],8,Oa)):i.type=="file"?(p(),g("div",{key:1,class:N(["flex items-center max-w-[82%] overflow-hidden",[i.chatId==m(t)?"mr-[12px]":"ml-[12px]"]])},[f("span",La,"文件："+O(i.picImg.slice(i.picImg.lastIndexOf("/"),i.picImg.length)),1),w($,{size:"small",onClick:ie=>Y(i.picImg)},{default:C(()=>[H("点击下载")]),_:2},1032,["onClick"])],2)):(p(),g("div",{key:2,ref_for:!0,ref_key:"chatList",ref:v,class:N(["bg-gray-100 rounded-lg text-[14px] max-w-[82%] p-[4px] relative z-10",[i.chatId==m(t)?"mr-[12px] ml-[12px]":"ml-[12px] mr-[12px] bg-green-500 text-white"]]),"data-id":i.msgId},[f("span",{class:"inline-block w-full overflow-hidden",innerHTML:i.msg},null,8,Pa),i.chatId==m(t)?(p(),g("span",Da,[w(me,{size:"18",icon:i.isRead?"ion:checkmark-done-outline":"ion:checkmark-outline"},null,8,["icon"])])):P("",!0),f("span",{class:N(["absolute text-[10px] text-gray-400 bottom-[-14px] whitespace-nowrap",[i.chatId==m(t)?"right-0":"left-0"]])},O(m(de)(i.time).format("MM-DD HH:mm:ss")),3)],10,za))],2))),128))])],512),f("div",Ba,[tt(f("span",Aa,[H("对方正在输入中"),Ma],512),[[at,m(se)]]),w(q,{modelValue:m(r).msg,"onUpdate:modelValue":o[1]||(o[1]=i=>m(r).msg=i),onKeyup:st(I,["enter"]),onInput:Ne,placeholder:"请输入内容",clearable:""},{right:C(()=>[f("div",Ra,[w(X,{ref_key:"myUploader",ref:d,url:"/api/upload",onSuccess:W,"before-upload":z,onFailure:A,name:"image"},{default:C(()=>[w(m(lt),{name:"image",size:"24"})]),_:1},512),w(T,{style:{"margin-left":"10px"},type:"primary",size:"small",icon:"",onClick:I},{icon:C(()=>[w(me,{icon:"ion:paper-plane-outline"})]),default:C(()=>[H("发送 ")]),_:1})])]),_:1},8,["modelValue","onKeyup"])]),w(oe,{visible:m(j),"onUpdate:visible":o[2]||(o[2]=i=>pe(j)?j.value=i:null)},{default:C(()=>[ja]),_:1},8,["visible"]),w(De,{visible:m(F),"onUpdate:visible":o[3]||(o[3]=i=>pe(F)?F.value=i:null),"cancel-txt":"取消","menu-items":m(Le),onChoose:ze},null,8,["visible","menu-items"])],64)}}});const qa=ct(Fa,[["__scopeId","data-v-778dfe50"]]);export{qa as default};
