import{J as Be,K as He,o as p,d as g,l as N,n as te,e as f,as as Ae,P as re,Y as Me,a4 as Re,c as Z,_ as we,b as xe,at as je,h as le,j as ce,t as C,H as O,k as P,f as Ie,F as ee,C as ke,L as Fe,i as Ce,r as x,au as Ve,av as Ue,aw as We,ax as Se,ab as Ye,m as Ge,ac as Je,ad as Ke,ay as Xe,a as ue,az as qe,N as Qe,aA as Ze,w as et,p as de,s as w,v as m,a9 as tt,ai as at,A as F,aB as st,x as pe,I as nt,z as ot,y as B,V as it,W as rt,a2 as me,aC as lt,X as ct}from"./index-7e616a8f.js";import{I as ut}from"./index-744d7de5.js";import{B as fe}from"./index-2883e15a.js";import{U as dt}from"./index-9c202d6a.js";import{g as ge,C as pt,N as mt,w as ft,s as gt}from"./index-ab8c3aad.js";import"./Checked-85d2ec3a.js";import"./index-29892cda-6953e93f.js";import"./index-7a7385e4-f394846d.js";import"./raf-729dad54-ba0b80ac.js";const vt=He("horizontal-n"),ht=f("path",{d:"M977.455 124.121H46.545C21.721 124.121 0 102.4 0 77.576S21.721 31.03 46.545 31.03h930.91c24.824 0 46.545 21.722 46.545 46.546s-21.721 46.545-46.545 46.545zm0 868.849H46.545C21.721 992.97 0 971.248 0 946.424s21.721-46.545 46.545-46.545h930.91c24.824 0 46.545 21.721 46.545 46.545s-21.721 46.546-46.545 46.546zm0-434.425H356.848c-24.824 0-46.545-21.72-46.545-46.545s21.721-46.545 46.545-46.545h620.607c24.824 0 46.545 21.72 46.545 46.545s-21.721 46.545-46.545 46.545z",fill:"currentColor","fill-opacity":"0.9"},null,-1),_t=[ht];function yt(e,t,o,h,l,_){return p(),g("svg",{class:N(e.classes),style:te(e.style),xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024",role:"presentation"},_t,6)}const bt=Be(vt,[["render",yt]]),wt=e=>e,xt=wt(Ae);var It=Object.defineProperty,kt=Object.defineProperties,Ct=Object.getOwnPropertyDescriptors,ve=Object.getOwnPropertySymbols,St=Object.prototype.hasOwnProperty,$t=Object.prototype.propertyIsEnumerable,he=(e,t,o)=>t in e?It(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,Tt=(e,t)=>{for(var o in t||(t={}))St.call(t,o)&&he(e,o,t[o]);if(ve)for(var o of ve(t))$t.call(t,o)&&he(e,o,t[o]);return e},Et=(e,t)=>kt(e,Ct(t));const{componentName:Ot,create:Nt}=xe("action-sheet"),Lt=Nt({components:{[re.name]:re,Loading:Me},props:Et(Tt({},je),{cancelTxt:{type:String,default:""},optionTag:{type:String,default:"name"},optionSubTag:{type:String,default:"subname"},chooseTagValue:{type:String,default:""},title:{type:String,default:""},color:{type:String,default:"#ee0a24"},description:{type:String,default:""},menuItems:{type:Array,default:()=>[]},closeAbled:{type:Boolean,default:!0}}),emits:["cancel","close","choose","update:visible"],setup(e,{emit:t}){const o=!!Re().default,h=Z(()=>({[Ot]:!0}));return{slotDefault:o,isHighlight:n=>e.chooseTagValue&&e.chooseTagValue===n[e.optionTag]?e.color:"",cancelActionSheet:()=>{t("cancel"),t("update:visible",!1)},chooseItem:(n,v)=>{!n.disable&&!n.loading&&(t("choose",n,v),t("update:visible",!1))},close:n=>{e.closeAbled&&(t("close",n),t("update:visible",!1))},classes:h}}}),zt={key:0,class:"nut-action-sheet__title"},Pt={key:1},Dt={key:0,class:"nut-action-sheet__item nut-action-sheet__desc"},Bt={key:1,class:"nut-action-sheet__menu"},Ht=["onClick"],At={key:1},Mt={class:"nut-action-sheet__subdesc"};function Rt(e,t,o,h,l,_){const i=le("Loading"),d=le("nut-popup");return p(),ce(d,{visible:e.visible,position:"bottom",round:"","close-on-click-overlay":e.closeAbled,"lock-scroll":e.lockScroll,onClickOverlay:e.close},{default:C(()=>[f("view",{class:N(e.classes)},[e.title?(p(),g("view",zt,O(e.title),1)):P("",!0),Ie(e.$slots,"default"),e.slotDefault?P("",!0):(p(),g("view",Pt,[e.description?(p(),g("view",Dt,O(e.description),1)):P("",!0),e.menuItems.length?(p(),g("view",Bt,[(p(!0),g(ee,null,ke(e.menuItems,(n,v)=>(p(),g("view",{key:v,class:N(["nut-action-sheet__item",{"nut-action-sheet__item--disabled":n.disable,"nut-action-sheet__item--loading":n.loading}]),style:te({color:e.isHighlight(n)||n.color}),onClick:I=>e.chooseItem(n,v)},[n.loading?(p(),ce(i,{key:0,name:"loading"})):(p(),g("view",At,O(n[e.optionTag]),1)),f("view",Mt,O(n[e.optionSubTag]),1)],14,Ht))),128))])):P("",!0),e.cancelTxt?(p(),g("view",{key:2,class:"nut-action-sheet__cancel",onClick:t[0]||(t[0]=(...n)=>e.cancelActionSheet&&e.cancelActionSheet(...n))},O(e.cancelTxt),1)):P("",!0)]))],2)]),_:3},8,["visible","close-on-click-overlay","lock-scroll","onClickOverlay"])}const jt=we(Lt,[["render",Rt]]),Ft=e=>e,Vt=Ft(jt),{create:Ut}=xe("avatar"),Wt=Ut({props:{size:{type:[String,Number],default:"normal"},shape:{type:String,default:"round"},bgColor:{type:String,default:"#eee"},color:{type:String,default:"#666"}},setup(e){const{size:t,shape:o,bgColor:h,color:l}=Fe(e),_=["large","normal","small"],i=Ce("avatarGroup",null),d=x(null),n=Z(()=>{var I,b;return{["nut-avatar"]:!0,[`nut-avatar-${t.value||((I=i==null?void 0:i.props)==null?void 0:I.size)||"normal"}`]:!0,[`nut-avatar-${o.value||((b=i==null?void 0:i.props)==null?void 0:b.shape)||"round"}`]:!0}}),v=Z(()=>{var I,b;return{width:t.value in _?"":`${t.value}px`,height:t.value in _?"":`${t.value}px`,backgroundColor:`${h.value}`,color:`${l.value}`,marginLeft:(I=i==null?void 0:i.props)!=null&&I.span?`${(b=i==null?void 0:i.props)==null?void 0:b.span}px`:""}});return{classes:n,styles:v,avatarRef:d}}});function Yt(e,t,o,h,l,_){return p(),g("view",{ref:"avatarRef",style:te(e.styles),class:N(e.classes)},[Ie(e.$slots,"default")],6)}const Gt=we(Wt,[["render",Yt]]),Jt=e=>e,Kt=Jt(Gt);const Xt="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ccircle cx='18' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='.67' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3Ccircle cx='12' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='.33' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3Ccircle cx='6' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='0' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3C!-- 1701252868811 --%3E%3C/svg%3E",$e=Xt,qt=""+new URL("chatBg-91517f37.jpg",import.meta.url).href;var Qt=Ve,Zt=function(){return Qt.Date.now()},ea=Zt,ta=/\s/;function aa(e){for(var t=e.length;t--&&ta.test(e.charAt(t)););return t}var sa=aa,na=sa,oa=/^\s+/;function ia(e){return e&&e.slice(0,na(e)+1).replace(oa,"")}var ra=ia,la=Ue,ca=We,ua="[object Symbol]";function da(e){return typeof e=="symbol"||ca(e)&&la(e)==ua}var pa=da,ma=ra,_e=Se,fa=pa,ye=0/0,ga=/^[-+]0x[0-9a-f]+$/i,va=/^0b[01]+$/i,ha=/^0o[0-7]+$/i,_a=parseInt;function ya(e){if(typeof e=="number")return e;if(fa(e))return ye;if(_e(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=_e(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=ma(e);var o=va.test(e);return o||ha.test(e)?_a(e.slice(2),o?2:8):ga.test(e)?ye:+e}var ba=ya,wa=Se,Q=ea,be=ba,xa="Expected a function",Ia=Math.max,ka=Math.min;function Ca(e,t,o){var h,l,_,i,d,n,v=0,I=!1,b=!1,L=!0;if(typeof e!="function")throw new TypeError(xa);t=be(t)||0,wa(o)&&(I=!!o.leading,b="maxWait"in o,_=b?Ia(be(o.maxWait)||0,t):_,L="trailing"in o?!!o.trailing:L);function D(u){var k=h,S=l;return h=l=void 0,v=u,i=e.apply(S,k),i}function U(u){return v=u,d=setTimeout(z,t),I?D(u):i}function W(u){var k=u-n,S=u-v,M=t-k;return b?ka(M,_-S):M}function H(u){var k=u-n,S=u-v;return n===void 0||k>=t||k<0||b&&S>=_}function z(){var u=Q();if(H(u))return A(u);d=setTimeout(z,W(u))}function A(u){return d=void 0,L&&h?D(u):(h=l=void 0,i)}function Y(){d!==void 0&&clearTimeout(d),v=0,h=n=l=d=void 0}function G(){return d===void 0?i:A(Q())}function E(){var u=Q(),k=H(u);if(h=arguments,l=this,n=u,k){if(d===void 0)return U(n);if(b)return clearTimeout(d),d=setTimeout(z,t),D(n)}return d===void 0&&(d=setTimeout(z,t)),i}return E.cancel=Y,E.flush=G,E}var Sa=Ca;const $a=Ye(Sa);var V=ge.registerPlugin(pt)||ge;V.core.Tween;const ae=e=>(it("data-v-12c42309"),e=e(),rt(),e),Ta={class:"flex items-center"},Ea=ae(()=>f("span",null," 刷新",-1)),Oa=["onClick"],Na=["src"],La={class:"text-[12px]"},za=["data-id"],Pa=["innerHTML"],Da={key:0,class:"absolute left-[-20px] top-[10px] text-[#858585]"},Ba={class:"relative"},Ha={class:"text-red-500 absolute top-[-10px] text-[12px] left-[4px] z-10 bg-white flex"},Aa=ae(()=>f("img",{src:$e,alt:"",srcset:""},null,-1)),Ma={class:"flex items-center"},Ra=ae(()=>f("div",{class:"wrapper"},[f("img",{src:qt,class:"w-full",alt:"",srcset:""})],-1)),ja=Ge({__name:"chat",setup(e){const t=Je("chatId","");t.value=Ke().query.id;const o=Ce("socket");console.log($e);const{copy:h}=Xe({legacy:!0}),l=ue({msg:"",name:t.value=="1"?"小扈":"老胡",chatId:t.value,picImg:"",type:"text",msgId:""}),_=qe(),i=x(null),d=x(null),n=x([]),v=x(null),I=()=>{if(l.msg=="")return B.fail("请输入内容");l.type="text",l.msgId=new Date().getTime().toString(),o.emit("chat",l),n.value.push(JSON.parse(JSON.stringify(l))),l.msg="",b(!1)},b=a=>{nt(()=>{var y,$;V.to(i.value,{scrollTop:(y=i.value)==null?void 0:y.scrollHeight,duration:.3});let s=v.value[(($=v.value)==null?void 0:$.length)-1],c=a?-100:100;V.fromTo(s,{opacity:0,x:c},{opacity:1,duration:.3,x:0}),a&&Pe.observe(s)})};o.on("chat",a=>{n.value.push(a),b(!0),_.value!="visible"&&t.value=="2"&&alert("有消息了")}),o.on("chatEnter",a=>{se.value=a.entering}),o.on("chatDelete",a=>{let s=n.value.findIndex(c=>c.msgId==a);n.value.splice(s,1)}),o.on("read",a=>{a.forEach(s=>{let c=n.value.findIndex(y=>y.msgId==(s.msgId||s));n.value[c].isRead=!0})});const L=a=>new Promise(s=>{const c=new FileReader;c.onloadend=y=>s(y.target.result),c.readAsDataURL(a)}),D=(a,s,c)=>new Promise(y=>a.toBlob($=>y($),s,c)),U=a=>new Promise(s=>{const c=new Image;c.onload=()=>s(c),c.src=a}),W=a=>{l.picImg=JSON.parse(a.responseText).data,l.msgId=new Date().getTime().toString(),o.emit("chat",l),d.value.clearUploadQueue(),l.picImg=""},H=a=>{B.fail(a)},z=async a=>{if(A(a[0])){l.type="img";let c=a[0].name;const y=document.createElement("canvas"),$=y.getContext("2d"),X=await L(a[0]),T=await U(X);y.width=T.width,y.height=T.height,$.clearRect(0,0,T.width,T.height),$.drawImage(T,0,0,T.width,T.height);let q=await D(y,"image/jpeg",.5);return[await new File([q],c)]}l.type="file";let s=await new File([a[0]],a[0].name);return console.log(s),[s]};function A(a){return a.type.startsWith("image/")}const Y=a=>{const s=document.createElement("a");s.href=a,s.download=a.slice(a.lastIndexOf("/"),a.length),s.click()};Qe(()=>{});const G=x(20),E=x(1),u=async()=>{let a=await ot.get("/chatList",{params:{pageSize:G.value,pageNum:E.value}});n.value.unshift(...a.data),k.value=!1,E.value==1&&setTimeout(()=>{V.to(i.value,{scrollTop:i.value.scrollHeight,duration:.5});let s=n.value.filter(c=>c.chatId!=t.value);s.length>0&&o.emit("read",s)},800),a.data.length==0&&Oe()};u();const k=x(!1),{y:S,directions:M}=Ze(i,{offset:{top:30,bottom:30,right:30,left:30}}),Te=$a(async()=>{var s,c;E.value++;let a=(s=i.value)==null?void 0:s.scrollHeight;await u(),S.value=((c=i.value)==null?void 0:c.scrollHeight)-a-10},500),Ee=()=>{E.value=1,n.value=[],u()},Oe=et(S,()=>{S.value<11&&M.top&&Te()}),J=x(!1),se=x(!1);let ne=null;const Ne=()=>{clearTimeout(ne),J.value||(J.value=!0,o.emit("chatEnter",{entering:!0})),ne=setTimeout(()=>{J.value=!1,o.emit("chatEnter",{entering:!1})},1500)},R=x(!1),j=x(!1),Le=ue([{name:"删除当条消息",type:"delete"},{name:"复制消息",type:"copy"}]),K=x(""),ze=async a=>{if(a.type=="delete")o.emit("chatDelete",K.value),B.success("删除成功");else{let s=n.value.find(c=>c.msgId==K.value);console.log(s);try{await h(s.msg||s.picImg),B.success("复制成功")}catch{B.fail("复制失败")}}},Pe=new IntersectionObserver(a=>{a.forEach(s=>{s.isIntersecting&&(console.log(de().format("YYYY-MM-DD HH:mm:ss")),console.log(_.value),_.value=="visible"&&o.emit("read",[s.target.dataset.id]))})},{});return(a,s)=>{const c=mt,y=Kt,$=fe,X=dt,T=fe,q=ut,oe=xt,De=Vt;return p(),g(ee,null,[w(c,{title:"小小聊天室",fixed:"",class:"bg-gray-300",onClickRight:s[0]||(s[0]=r=>R.value=!0),onClickBack:Ee},{left:C(()=>[f("div",Ta,[Ea,w(m(ft),{width:"18px"})])]),right:C(()=>[w(m(bt),{class:"right",width:"18px"})]),_:1}),f("div",{style:{height:"calc(100vh - 96px)"},class:"overflow-y-auto overflow-x-hidden",ref_key:"chatBox",ref:i},[f("ul",null,[(p(!0),g(ee,null,ke(m(n),r=>(p(),g("li",{class:N(["flex mt-[10px] mb-[24px]",{"flex-row-reverse":r.chatId==m(t)}]),key:r.msgId},[w(y,{onClick:ie=>{j.value=!0,K.value=r.msgId},class:"z-20 relative",color:"rgb(245, 106, 0)","bg-color":"rgb(253, 227, 207)"},{default:C(()=>[F(O(r.name),1)]),_:2},1032,["onClick"]),r.type=="img"?(p(),g("div",{key:0,onClick:ie=>m(gt)({show:!0,images:[{src:r.picImg}]}),class:"mx-[12px]"},[f("img",{src:r.picImg,alt:"",srcset:""},null,8,Na)],8,Oa)):r.type=="file"?(p(),g("div",{key:1,class:N(["flex items-center max-w-[82%] overflow-hidden",[r.chatId==m(t)?"mr-[12px]":"ml-[12px]"]])},[f("span",La,"文件："+O(r.picImg.slice(r.picImg.lastIndexOf("/"),r.picImg.length)),1),w($,{size:"small",onClick:ie=>Y(r.picImg)},{default:C(()=>[F("点击下载")]),_:2},1032,["onClick"])],2)):(p(),g("div",{key:2,ref_for:!0,ref_key:"chatList",ref:v,class:N(["bg-gray-100 rounded-lg text-[14px] max-w-[82%] p-[4px] relative z-10",[r.chatId==m(t)?"mr-[12px] ml-[12px]":"ml-[12px] mr-[12px] bg-green-500 text-white"]]),"data-id":r.msgId},[f("span",{class:"inline-block w-full overflow-hidden",innerHTML:r.msg},null,8,Pa),r.chatId==m(t)?(p(),g("span",Da,[w(me,{size:"18",icon:r.isRead?"ion:checkmark-done-outline":"ion:checkmark-outline"},null,8,["icon"])])):P("",!0),f("span",{class:N(["absolute text-[10px] text-gray-400 bottom-[-14px] whitespace-nowrap",[r.chatId==m(t)?"right-0":"left-0"]])},O(m(de)(r.time).format("MM-DD HH:mm:ss")),3)],10,za))],2))),128))])],512),f("div",Ba,[tt(f("span",Ha,[F("对方正在输入中"),Aa],512),[[at,m(se)]]),w(q,{modelValue:m(l).msg,"onUpdate:modelValue":s[1]||(s[1]=r=>m(l).msg=r),onKeyup:st(I,["enter"]),onInput:Ne,placeholder:"请输入内容",clearable:""},{right:C(()=>[f("div",Ma,[w(X,{ref_key:"myUploader",ref:d,url:"/api/upload",onSuccess:W,"before-upload":z,onFailure:H,name:"image"},{default:C(()=>[w(m(lt),{name:"image",size:"24"})]),_:1},512),w(T,{style:{"margin-left":"10px"},type:"primary",size:"small",icon:"",onClick:I},{icon:C(()=>[w(me,{icon:"ion:paper-plane-outline"})]),default:C(()=>[F("发送 ")]),_:1})])]),_:1},8,["modelValue","onKeyup"])]),w(oe,{visible:m(R),"onUpdate:visible":s[2]||(s[2]=r=>pe(R)?R.value=r:null)},{default:C(()=>[Ra]),_:1},8,["visible"]),w(De,{visible:m(j),"onUpdate:visible":s[3]||(s[3]=r=>pe(j)?j.value=r:null),"cancel-txt":"取消","menu-items":m(Le),onChoose:ze},null,8,["visible","menu-items"])],64)}}});const qa=ct(ja,[["__scopeId","data-v-12c42309"]]);export{qa as default};
