import{J as Fe,K as Ve,o as m,d as g,l as z,n as se,e as h,O as Ue,$ as We,a6 as Ye,_ as ke,b as Ce,as as Ke,h as ue,j as de,t as C,H as T,k as L,f as $e,F as U,C as ae,L as Je,i as Se,r as x,c as pe,at as Ge,au as Qe,av as Xe,aw as Te,ad as qe,m as Ee,a as te,v,ae as Ze,af as et,ax as tt,ay as st,Q as at,az as nt,w as ot,p as me,aA as it,s as b,ab as fe,ak as ge,A as F,aB as lt,x as ve,I as rt,z as ct,y as R,aC as ut,X as dt,Y as pt,a4 as Z,aD as mt,N as he,Z as ft}from"./index-17035d4d.js";import{i as gt}from"./index-6b1abaae.js";/* empty css              */import{i as vt}from"./index-afa6e6a6.js";import{g as _e,C as ht,i as _t,w as yt,s as bt}from"./index-da01d4e7.js";import"./Checked-6ee013ec.js";import"./index-rf29bejW-f5851efe.js";import"./index-084nl_oE-3d2a57de.js";import"./raf-MQjoO-Ag-cbde852a.js";const xt=Ve("horizontal-n"),wt=h("path",{d:"M977.455 124.121H46.545C21.721 124.121 0 102.4 0 77.576S21.721 31.03 46.545 31.03h930.91c24.824 0 46.545 21.722 46.545 46.546s-21.721 46.545-46.545 46.545zm0 868.849H46.545C21.721 992.97 0 971.248 0 946.424s21.721-46.545 46.545-46.545h930.91c24.824 0 46.545 21.721 46.545 46.545s-21.721 46.546-46.545 46.546zm0-434.425H356.848c-24.824 0-46.545-21.72-46.545-46.545s21.721-46.545 46.545-46.545h620.607c24.824 0 46.545 21.72 46.545 46.545s-21.721 46.545-46.545 46.545z",fill:"currentColor","fill-opacity":"0.9"},null,-1),It=[wt];function kt(e,t,n,_,i,f){return m(),g("svg",{class:z(e.classes),style:se(e.style),xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024",role:"presentation"},It,6)}const Ct=Fe(xt,[["render",kt]]);var $t=Object.defineProperty,St=Object.defineProperties,Tt=Object.getOwnPropertyDescriptors,ye=Object.getOwnPropertySymbols,Et=Object.prototype.hasOwnProperty,Ot=Object.prototype.propertyIsEnumerable,be=(e,t,n)=>t in e?$t(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,zt=(e,t)=>{for(var n in t||(t={}))Et.call(t,n)&&be(e,n,t[n]);if(ye)for(var n of ye(t))Ot.call(t,n)&&be(e,n,t[n]);return e},Nt=(e,t)=>St(e,Tt(t));const{create:jt}=Ce("action-sheet"),Lt=jt({components:{NutPopup:Ue,Loading:We},props:Nt(zt({},Ke),{cancelTxt:{type:String,default:""},optionTag:{type:String,default:"name"},optionSubTag:{type:String,default:"subname"},chooseTagValue:{type:String,default:""},title:{type:String,default:""},color:{type:String,default:"#ee0a24"},description:{type:String,default:""},menuItems:{type:Array,default:()=>[]},closeAbled:{type:Boolean,default:!0}}),emits:["cancel","close","choose","update:visible"],setup(e,{emit:t}){return{slotDefault:!!Ye().default,isHighlight:o=>e.chooseTagValue&&e.chooseTagValue===o[e.optionTag]?e.color:"",cancelActionSheet:()=>{t("cancel"),t("update:visible",!1)},chooseItem:(o,c)=>{!o.disable&&!o.loading&&(t("choose",o,c),t("update:visible",!1))},close:o=>{e.closeAbled&&(t("close",o),t("update:visible",!1))}}}}),Dt={class:"nut-action-sheet"},Pt={key:0,class:"nut-action-sheet__title"},Rt={key:1},At={key:0,class:"nut-action-sheet__item nut-action-sheet__desc"},Ht={key:1,class:"nut-action-sheet__menu"},Bt=["onClick"],Mt={key:1},Ft={class:"nut-action-sheet__subdesc"};function Vt(e,t,n,_,i,f){const u=ue("Loading"),o=ue("nut-popup");return m(),de(o,{visible:e.visible,position:"bottom",round:"","close-on-click-overlay":e.closeAbled,"lock-scroll":e.lockScroll,"z-index":e.zIndex,onClickOverlay:e.close},{default:C(()=>[h("view",Dt,[e.title?(m(),g("view",Pt,T(e.title),1)):L("",!0),$e(e.$slots,"default"),e.slotDefault?L("",!0):(m(),g("view",Rt,[e.description?(m(),g("view",At,T(e.description),1)):L("",!0),e.menuItems.length?(m(),g("view",Ht,[(m(!0),g(U,null,ae(e.menuItems,(c,p)=>(m(),g("view",{key:p,class:z(["nut-action-sheet__item",{"nut-action-sheet__item--disabled":c.disable,"nut-action-sheet__item--loading":c.loading}]),style:se({color:e.isHighlight(c)||c.color}),onClick:I=>e.chooseItem(c,p)},[c.loading?(m(),de(u,{key:0})):(m(),g("view",Mt,T(c[e.optionTag]),1)),h("view",Ft,T(c[e.optionSubTag]),1)],14,Bt))),128))])):L("",!0),e.cancelTxt?(m(),g("view",{key:2,class:"nut-action-sheet__cancel",onClick:t[0]||(t[0]=(...c)=>e.cancelActionSheet&&e.cancelActionSheet(...c))},T(e.cancelTxt),1)):L("",!0)]))])]),_:3},8,["visible","close-on-click-overlay","lock-scroll","z-index","onClickOverlay"])}const Ut=ke(Lt,[["render",Vt]]),Wt=Symbol("nut-avatar"),{create:Yt}=Ce("avatar"),Kt=Yt({props:{size:{type:[String,Number],default:"normal"},shape:{type:String,default:"round"},bgColor:{type:String,default:"#eee"},color:{type:String,default:"#666"}},setup(e){const{size:t,shape:n,bgColor:_,color:i}=Je(e),f=["large","normal","small"],u=Se(Wt,null),o=x(null),c=pe(()=>{var I,w;return{["nut-avatar"]:!0,[`nut-avatar-${t.value||((I=u==null?void 0:u.props)==null?void 0:I.size)||"normal"}`]:!0,[`nut-avatar-${n.value||((w=u==null?void 0:u.props)==null?void 0:w.shape)||"round"}`]:!0}}),p=pe(()=>{var I,w;return{width:t.value in f?"":`${t.value}px`,height:t.value in f?"":`${t.value}px`,backgroundColor:`${_.value}`,color:`${i.value}`,marginLeft:(I=u==null?void 0:u.props)!=null&&I.span?`${(w=u==null?void 0:u.props)==null?void 0:w.span}px`:""}});return{classes:c,styles:p,avatarRef:o}}});function Jt(e,t,n,_,i,f){return m(),g("view",{ref:"avatarRef",style:se(e.styles),class:z(e.classes)},[$e(e.$slots,"default")],6)}const Gt=ke(Kt,[["render",Jt]]);const Qt="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ccircle cx='18' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='.67' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3Ccircle cx='12' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='.33' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3Ccircle cx='6' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='0' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3C!-- 1701252868811 --%3E%3C/svg%3E",Oe=Qt,Xt=""+new URL("chatBg-cdb6162e.jpg",import.meta.url).href;var qt=Ge,Zt=function(){return qt.Date.now()},es=Zt,ts=/\s/;function ss(e){for(var t=e.length;t--&&ts.test(e.charAt(t)););return t}var as=ss,ns=as,os=/^\s+/;function is(e){return e&&e.slice(0,ns(e)+1).replace(os,"")}var ls=is,rs=Qe,cs=Xe,us="[object Symbol]";function ds(e){return typeof e=="symbol"||cs(e)&&rs(e)==us}var ps=ds,ms=ls,xe=Te,fs=ps,we=0/0,gs=/^[-+]0x[0-9a-f]+$/i,vs=/^0b[01]+$/i,hs=/^0o[0-7]+$/i,_s=parseInt;function ys(e){if(typeof e=="number")return e;if(fs(e))return we;if(xe(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=xe(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=ms(e);var n=vs.test(e);return n||hs.test(e)?_s(e.slice(2),n?2:8):gs.test(e)?we:+e}var bs=ys,xs=Te,ee=es,Ie=bs,ws="Expected a function",Is=Math.max,ks=Math.min;function Cs(e,t,n){var _,i,f,u,o,c,p=0,I=!1,w=!1,E=!0;if(typeof e!="function")throw new TypeError(ws);t=Ie(t)||0,xs(n)&&(I=!!n.leading,w="maxWait"in n,f=w?Is(Ie(n.maxWait)||0,t):f,E="trailing"in n?!!n.trailing:E);function D(d){var k=_,O=i;return _=i=void 0,p=d,u=e.apply(O,k),u}function W(d){return p=d,o=setTimeout(N,t),I?D(d):u}function Y(d){var k=d-c,O=d-p,j=t-k;return w?ks(j,f-O):j}function A(d){var k=d-c,O=d-p;return c===void 0||k>=t||k<0||w&&O>=f}function N(){var d=ee();if(A(d))return H(d);o=setTimeout(N,Y(d))}function H(d){return o=void 0,E&&_?D(d):(_=i=void 0,u)}function K(){o!==void 0&&clearTimeout(o),p=0,_=c=i=o=void 0}function J(){return o===void 0?u:H(ee())}function P(){var d=ee(),k=A(d);if(_=arguments,i=this,c=d,k){if(o===void 0)return W(c);if(w)return clearTimeout(o),o=setTimeout(N,t),D(c)}return o===void 0&&(o=setTimeout(N,t)),u}return P.cancel=K,P.flush=J,P}var $s=Cs;const Ss=qe($s);var V=_e.registerPlugin(ht)||_e;V.core.Tween;const Ts={class:"w-full bg-[#f4f4f4] z-50"},Es={class:"grid grid-cols-8 gap-[4px] py-[4px]"},Os=["onClick"],zs=Ee({__name:"emoji",emits:["emojiClick"],setup(e,{emit:t}){const n=te(["😀","😄","😆","😅","🤣","😂","🥰","🤩","😘","🥲","😋","🫢","🫣","😝","🫡","🤔","🤨","😑","😏","🙄","😮‍💨","😌","😔","😪","🤒","😎","🤓","🧐","😟","🥹","😳","😠","😵‍💫","🤤","👍","✊","🙏","🤝","👀"]);return(_,i)=>(m(),g("div",Ts,[h("div",Es,[(m(!0),g(U,null,ae(v(n),(f,u)=>(m(),g("div",{key:u,class:"text-center text-[24px] cursor-pointer",onClick:o=>_.$emit("emojiClick",f)},T(f),9,Os))),128))])]))}}),ne=e=>(dt("data-v-a61d4021"),e=e(),pt(),e),Ns={class:"flex items-center"},js=ne(()=>h("span",null," 刷新",-1)),Ls=["onClick"],Ds=["src"],Ps={class:"text-[12px]"},Rs=["data-id"],As=["innerHTML"],Hs={key:0,class:"absolute left-[-20px] top-[10px] text-[#858585]"},Bs={class:"relative"},Ms={class:"text-red-500 absolute top-[-10px] text-[12px] left-[4px] z-10 bg-white flex"},Fs=ne(()=>h("img",{src:Oe,alt:"",srcset:""},null,-1)),Vs={class:"flex items-center"},Us=ne(()=>h("div",{class:"wrapper"},[h("img",{src:Xt,class:"w-full",alt:"",srcset:""})],-1)),Ws=Ee({__name:"chat",setup(e){const t=Ze("chatId","");t.value=et().query.id;const n=Se("socket");console.log(Oe);const{copy:_}=tt({legacy:!0}),i=te({msg:"",name:t.value=="1"?"小扈":"老胡",chatId:t.value,picImg:"",type:"text",msgId:""}),f=x(!1),u=st(),o=x(null),c=x(null),p=x([]),I=x(null),w=()=>{if(i.msg=="")return R.fail("请输入内容");i.type="text",i.msgId=new Date().getTime().toString(),n.emit("chat",i),p.value.push(JSON.parse(JSON.stringify(i))),i.msg="",E(!1)},E=s=>{rt(()=>{var y,$;V.to(o.value,{scrollTop:(y=o.value)==null?void 0:y.scrollHeight,duration:.3});let a=I.value[(($=I.value)==null?void 0:$.length)-1],r=s?-100:100;V.fromTo(a,{opacity:0,x:r},{opacity:1,duration:.3,x:0}),s&&Ae.observe(a)})};n.on("chat",s=>{p.value.push(s),E(!0),u.value!="visible"&&t.value=="2"&&alert("有消息了")}),n.on("chatEnter",s=>{oe.value=s.entering}),n.on("chatDelete",s=>{let a=p.value.findIndex(r=>r.msgId==s);p.value.splice(a,1)}),n.on("read",s=>{s.forEach(a=>{let r=p.value.findIndex(y=>y.msgId==(a.msgId||a));p.value[r].isRead=!0})});const D=s=>new Promise(a=>{const r=new FileReader;r.onloadend=y=>a(y.target.result),r.readAsDataURL(s)}),W=(s,a,r)=>new Promise(y=>s.toBlob($=>y($),a,r)),Y=s=>new Promise(a=>{const r=new Image;r.onload=()=>a(r),r.src=s}),A=s=>{i.picImg=JSON.parse(s.responseText).data,i.msgId=new Date().getTime().toString(),n.emit("chat",i),c.value.clearUploadQueue(),i.picImg=""},N=s=>{R.fail(s)},H=async s=>{if(K(s[0])){i.type="img";let r=s[0].name;const y=document.createElement("canvas"),$=y.getContext("2d"),X=await D(s[0]),S=await Y(X);y.width=S.width,y.height=S.height,$.clearRect(0,0,S.width,S.height),$.drawImage(S,0,0,S.width,S.height);let q=await W(y,"image/jpeg",.5);return[await new File([q],r)]}i.type="file";let a=await new File([s[0]],s[0].name);return console.log(a),[a]};function K(s){return s.type.startsWith("image/")}const J=s=>{const a=document.createElement("a");a.href=s,a.download=s.slice(s.lastIndexOf("/"),s.length),a.click()};at(()=>{});const P=x(20),d=x(1),k=async()=>{let s=await ct.get("/chatList",{params:{pageSize:P.value,pageNum:d.value}});p.value.unshift(...s.data),O.value=!1,d.value==1&&setTimeout(()=>{V.to(o.value,{scrollTop:o.value.scrollHeight,duration:.5});let a=p.value.filter(r=>r.chatId!=t.value);a.length>0&&n.emit("read",a)},500),s.data.length==0&&Le()};k();const O=x(!1),{y:j,directions:ze}=nt(o,{offset:{top:30,bottom:30,right:30,left:30}}),Ne=Ss(async()=>{var a,r;d.value++;let s=(a=o.value)==null?void 0:a.scrollHeight;await k(),j.value=((r=o.value)==null?void 0:r.scrollHeight)-s-10},500),je=()=>{d.value=0,p.value=[]},Le=ot(j,()=>{j.value<11&&ze.top&&Ne()}),G=x(!1),oe=x(!1);let ie=null;const De=()=>{clearTimeout(ie),G.value||(G.value=!0,n.emit("chatEnter",{entering:!0})),ie=setTimeout(()=>{G.value=!1,n.emit("chatEnter",{entering:!1})},3e3)},B=x(!1),M=x(!1),Pe=te([{name:"删除当条消息",type:"delete"},{name:"复制消息",type:"copy"}]),Q=x(""),Re=async s=>{if(s.type=="delete")n.emit("chatDelete",Q.value),R.success("删除成功");else{let a=p.value.find(r=>r.msgId==Q.value);console.log(a);try{await _(a.msg||a.picImg),R.success("复制成功")}catch{R.fail("复制失败")}}},Ae=new IntersectionObserver(s=>{s.forEach(a=>{a.isIntersecting&&(console.log(me().format("YYYY-MM-DD HH:mm:ss")),console.log(u.value),u.value=="visible"&&n.emit("read",[a.target.dataset.id]))})},{}),He=s=>{i.msg=i.msg+s},le=x(null);it(le,()=>{f.value&&(f.value=!1)});const Be=()=>{f.value||(f.value=!0)};return(s,a)=>{const r=_t,y=Gt,$=he,X=vt,S=he,q=gt,re=ut,Me=Ut;return m(),g(U,null,[b(r,{title:"小小聊天室",fixed:"",class:"bg-gray-300",onClickRight:a[0]||(a[0]=l=>B.value=!0),onClickBack:je},{left:C(()=>[h("div",Ns,[js,b(v(yt),{width:"18px"})])]),right:C(()=>[b(v(Ct),{class:"right",width:"18px"})]),_:1}),h("div",{style:{height:"calc(100vh - 96px)"},class:"overflow-y-auto overflow-x-hidden",ref_key:"chatBox",ref:o},[h("ul",null,[(m(!0),g(U,null,ae(v(p),l=>(m(),g("li",{class:z(["flex mt-[10px] mb-[24px]",{"flex-row-reverse":l.chatId==v(t)}]),key:l.msgId},[b(y,{onClick:ce=>{M.value=!0,Q.value=l.msgId},class:"z-20 relative",color:"rgb(245, 106, 0)","bg-color":"rgb(253, 227, 207)"},{default:C(()=>[F(T(l.name),1)]),_:2},1032,["onClick"]),l.type=="img"?(m(),g("div",{key:0,onClick:ce=>v(bt)({show:!0,images:[{src:l.picImg}]}),class:"mx-[12px]"},[h("img",{src:l.picImg,alt:"",srcset:""},null,8,Ds)],8,Ls)):l.type=="file"?(m(),g("div",{key:1,class:z(["flex items-center max-w-[82%] overflow-hidden",[l.chatId==v(t)?"mr-[12px]":"ml-[12px]"]])},[h("span",Ps,"文件："+T(l.picImg.slice(l.picImg.lastIndexOf("/"),l.picImg.length)),1),b($,{size:"small",onClick:ce=>J(l.picImg)},{default:C(()=>[F("点击下载")]),_:2},1032,["onClick"])],2)):(m(),g("div",{key:2,ref_for:!0,ref_key:"chatList",ref:I,class:z(["bg-gray-100 rounded-lg text-[14px] max-w-[82%] p-[4px] relative z-10",[l.chatId==v(t)?"mr-[12px] ml-[12px]":"ml-[12px] mr-[12px] bg-green-500 text-white"]]),"data-id":l.msgId},[h("span",{class:"inline-block w-full overflow-hidden",innerHTML:l.msg},null,8,As),l.chatId==v(t)?(m(),g("span",Hs,[b(Z,{size:"18",icon:l.isRead?"ion:checkmark-done-outline":"ion:checkmark-outline"},null,8,["icon"])])):L("",!0),h("span",{class:z(["absolute text-[10px] text-gray-400 bottom-[-14px] whitespace-nowrap",[l.chatId==v(t)?"right-0":"left-0"]])},T(v(me)(l.time).format("MM-DD HH:mm:ss")),3)],10,Rs))],2))),128))])],512),h("div",Bs,[fe(h("span",Ms,[F("对方正在输入中"),Fs],512),[[ge,v(oe)]]),b(q,{modelValue:v(i).msg,"onUpdate:modelValue":a[1]||(a[1]=l=>v(i).msg=l),onKeyup:lt(w,["enter"]),onInput:De,placeholder:"请输入内容",clearable:""},{right:C(()=>[h("div",Vs,[b(Z,{icon:"carbon:face-wink",size:"24",class:"mr-[10px] cursor-pointer",onClick:Be}),b(X,{ref_key:"myUploader",ref:c,url:"/api/upload",onSuccess:A,"before-upload":H,onFailure:N,name:"image"},{default:C(()=>[b(v(mt),{name:"image",size:"24"})]),_:1},512),b(S,{style:{"margin-left":"10px"},type:"primary",size:"small",icon:"",onClick:w},{icon:C(()=>[b(Z,{icon:"ion:paper-plane-outline"})]),default:C(()=>[F("发送 ")]),_:1})])]),_:1},8,["modelValue","onKeyup"]),fe(b(zs,{ref_key:"emojiRef",ref:le,onEmojiClick:He,class:"absolute top-[-200px]"},null,512),[[ge,v(f)]])]),b(re,{visible:v(B),"onUpdate:visible":a[2]||(a[2]=l=>ve(B)?B.value=l:null)},{default:C(()=>[Us]),_:1},8,["visible"]),b(Me,{visible:v(M),"onUpdate:visible":a[3]||(a[3]=l=>ve(M)?M.value=l:null),"cancel-txt":"取消","menu-items":v(Pe),onChoose:Re},null,8,["visible","menu-items"])],64)}}});const ta=ft(Ws,[["__scopeId","data-v-a61d4021"]]);export{ta as default};
