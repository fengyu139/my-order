import{J as Be,K as Ae,o as p,d as g,l as N,n as te,e as f,ar as Me,P as ie,Y as Re,a3 as je,c as Z,_ as we,b as xe,as as Fe,h as le,j as ce,t as C,H as O,k as P,f as Ie,F as ee,C as ke,L as He,i as Ce,r as x,at as Ve,au as Ue,av as We,aw as Se,aa as Ye,m as Ge,ab as Je,ac as Ke,ax as Xe,a as ue,ay as qe,N as Qe,az as Ze,w as et,p as de,s as w,v as m,a8 as tt,ah as at,A as H,aA as st,x as pe,I as nt,z as ot,y as B,aB as rt,V as it,W as lt,X as ct}from"./index-f8cef8db.js";import{I as ut}from"./index-c084f3e1.js";import{B as me}from"./index-9ea07d5a.js";import{U as dt}from"./index-cbeb036d.js";import{g as fe,C as pt,N as mt,w as ft,s as gt}from"./index-83bb8677.js";import{_ as ge}from"./abIcon.vue_vue_type_style_index_0_lang-1a1a9b43.js";import"./Checked-1664ce92.js";import"./index-29892cda-4c2bd712.js";import"./index-7a7385e4-c5ab4cd4.js";import"./raf-729dad54-ecc02616.js";const vt=Ae("horizontal-n"),ht=f("path",{d:"M977.455 124.121H46.545C21.721 124.121 0 102.4 0 77.576S21.721 31.03 46.545 31.03h930.91c24.824 0 46.545 21.722 46.545 46.546s-21.721 46.545-46.545 46.545zm0 868.849H46.545C21.721 992.97 0 971.248 0 946.424s21.721-46.545 46.545-46.545h930.91c24.824 0 46.545 21.721 46.545 46.545s-21.721 46.546-46.545 46.546zm0-434.425H356.848c-24.824 0-46.545-21.72-46.545-46.545s21.721-46.545 46.545-46.545h620.607c24.824 0 46.545 21.72 46.545 46.545s-21.721 46.545-46.545 46.545z",fill:"currentColor","fill-opacity":"0.9"},null,-1),_t=[ht];function yt(e,t,n,h,i,y){return p(),g("svg",{class:N(e.classes),style:te(e.style),xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024",role:"presentation"},_t,6)}const bt=Be(vt,[["render",yt]]),wt=e=>e,xt=wt(Me);var It=Object.defineProperty,kt=Object.defineProperties,Ct=Object.getOwnPropertyDescriptors,ve=Object.getOwnPropertySymbols,St=Object.prototype.hasOwnProperty,$t=Object.prototype.propertyIsEnumerable,he=(e,t,n)=>t in e?It(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Tt=(e,t)=>{for(var n in t||(t={}))St.call(t,n)&&he(e,n,t[n]);if(ve)for(var n of ve(t))$t.call(t,n)&&he(e,n,t[n]);return e},Et=(e,t)=>kt(e,Ct(t));const{componentName:Ot,create:Nt}=xe("action-sheet"),Lt=Nt({components:{[ie.name]:ie,Loading:Re},props:Et(Tt({},Fe),{cancelTxt:{type:String,default:""},optionTag:{type:String,default:"name"},optionSubTag:{type:String,default:"subname"},chooseTagValue:{type:String,default:""},title:{type:String,default:""},color:{type:String,default:"#ee0a24"},description:{type:String,default:""},menuItems:{type:Array,default:()=>[]},closeAbled:{type:Boolean,default:!0}}),emits:["cancel","close","choose","update:visible"],setup(e,{emit:t}){const n=!!je().default,h=Z(()=>({[Ot]:!0}));return{slotDefault:n,isHighlight:a=>e.chooseTagValue&&e.chooseTagValue===a[e.optionTag]?e.color:"",cancelActionSheet:()=>{t("cancel"),t("update:visible",!1)},chooseItem:(a,v)=>{!a.disable&&!a.loading&&(t("choose",a,v),t("update:visible",!1))},close:a=>{e.closeAbled&&(t("close",a),t("update:visible",!1))},classes:h}}}),zt={key:0,class:"nut-action-sheet__title"},Pt={key:1},Dt={key:0,class:"nut-action-sheet__item nut-action-sheet__desc"},Bt={key:1,class:"nut-action-sheet__menu"},At=["onClick"],Mt={key:1},Rt={class:"nut-action-sheet__subdesc"};function jt(e,t,n,h,i,y){const l=le("Loading"),d=le("nut-popup");return p(),ce(d,{visible:e.visible,position:"bottom",round:"","close-on-click-overlay":e.closeAbled,"lock-scroll":e.lockScroll,onClickOverlay:e.close},{default:C(()=>[f("view",{class:N(e.classes)},[e.title?(p(),g("view",zt,O(e.title),1)):P("",!0),Ie(e.$slots,"default"),e.slotDefault?P("",!0):(p(),g("view",Pt,[e.description?(p(),g("view",Dt,O(e.description),1)):P("",!0),e.menuItems.length?(p(),g("view",Bt,[(p(!0),g(ee,null,ke(e.menuItems,(a,v)=>(p(),g("view",{key:v,class:N(["nut-action-sheet__item",{"nut-action-sheet__item--disabled":a.disable,"nut-action-sheet__item--loading":a.loading}]),style:te({color:e.isHighlight(a)||a.color}),onClick:I=>e.chooseItem(a,v)},[a.loading?(p(),ce(l,{key:0,name:"loading"})):(p(),g("view",Mt,O(a[e.optionTag]),1)),f("view",Rt,O(a[e.optionSubTag]),1)],14,At))),128))])):P("",!0),e.cancelTxt?(p(),g("view",{key:2,class:"nut-action-sheet__cancel",onClick:t[0]||(t[0]=(...a)=>e.cancelActionSheet&&e.cancelActionSheet(...a))},O(e.cancelTxt),1)):P("",!0)]))],2)]),_:3},8,["visible","close-on-click-overlay","lock-scroll","onClickOverlay"])}const Ft=we(Lt,[["render",jt]]),Ht=e=>e,Vt=Ht(Ft),{create:Ut}=xe("avatar"),Wt=Ut({props:{size:{type:[String,Number],default:"normal"},shape:{type:String,default:"round"},bgColor:{type:String,default:"#eee"},color:{type:String,default:"#666"}},setup(e){const{size:t,shape:n,bgColor:h,color:i}=He(e),y=["large","normal","small"],l=Ce("avatarGroup",null),d=x(null),a=Z(()=>{var I,b;return{["nut-avatar"]:!0,[`nut-avatar-${t.value||((I=l==null?void 0:l.props)==null?void 0:I.size)||"normal"}`]:!0,[`nut-avatar-${n.value||((b=l==null?void 0:l.props)==null?void 0:b.shape)||"round"}`]:!0}}),v=Z(()=>{var I,b;return{width:t.value in y?"":`${t.value}px`,height:t.value in y?"":`${t.value}px`,backgroundColor:`${h.value}`,color:`${i.value}`,marginLeft:(I=l==null?void 0:l.props)!=null&&I.span?`${(b=l==null?void 0:l.props)==null?void 0:b.span}px`:""}});return{classes:a,styles:v,avatarRef:d}}});function Yt(e,t,n,h,i,y){return p(),g("view",{ref:"avatarRef",style:te(e.styles),class:N(e.classes)},[Ie(e.$slots,"default")],6)}const Gt=we(Wt,[["render",Yt]]),Jt=e=>e,Kt=Jt(Gt);const $e="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ccircle cx='18' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='.67' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3Ccircle cx='12' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='.33' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3Ccircle cx='6' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='0' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3C!-- 1701252868811 --%3E%3C/svg%3E",Xt=""+new URL("chatBg-91517f37.jpg",import.meta.url).href;var qt=Ve,Qt=function(){return qt.Date.now()},Zt=Qt,ea=/\s/;function ta(e){for(var t=e.length;t--&&ea.test(e.charAt(t)););return t}var aa=ta,sa=aa,na=/^\s+/;function oa(e){return e&&e.slice(0,sa(e)+1).replace(na,"")}var ra=oa,ia=Ue,la=We,ca="[object Symbol]";function ua(e){return typeof e=="symbol"||la(e)&&ia(e)==ca}var da=ua,pa=ra,_e=Se,ma=da,ye=0/0,fa=/^[-+]0x[0-9a-f]+$/i,ga=/^0b[01]+$/i,va=/^0o[0-7]+$/i,ha=parseInt;function _a(e){if(typeof e=="number")return e;if(ma(e))return ye;if(_e(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=_e(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=pa(e);var n=ga.test(e);return n||va.test(e)?ha(e.slice(2),n?2:8):fa.test(e)?ye:+e}var ya=_a,ba=Se,Q=Zt,be=ya,wa="Expected a function",xa=Math.max,Ia=Math.min;function ka(e,t,n){var h,i,y,l,d,a,v=0,I=!1,b=!1,L=!0;if(typeof e!="function")throw new TypeError(wa);t=be(t)||0,ba(n)&&(I=!!n.leading,b="maxWait"in n,y=b?xa(be(n.maxWait)||0,t):y,L="trailing"in n?!!n.trailing:L);function D(c){var k=h,S=i;return h=i=void 0,v=c,l=e.apply(S,k),l}function U(c){return v=c,d=setTimeout(z,t),I?D(c):l}function W(c){var k=c-a,S=c-v,R=t-k;return b?Ia(R,y-S):R}function A(c){var k=c-a,S=c-v;return a===void 0||k>=t||k<0||b&&S>=y}function z(){var c=Q();if(A(c))return M(c);d=setTimeout(z,W(c))}function M(c){return d=void 0,L&&h?D(c):(h=i=void 0,l)}function Y(){d!==void 0&&clearTimeout(d),v=0,h=a=i=d=void 0}function G(){return d===void 0?l:M(Q())}function E(){var c=Q(),k=A(c);if(h=arguments,i=this,a=c,k){if(d===void 0)return U(a);if(b)return clearTimeout(d),d=setTimeout(z,t),D(a)}return d===void 0&&(d=setTimeout(z,t)),l}return E.cancel=Y,E.flush=G,E}var Ca=ka;const Sa=Ye(Ca);var V=fe.registerPlugin(pt)||fe;V.core.Tween;const ae=e=>(it("data-v-cf810247"),e=e(),lt(),e),$a={class:"flex items-center"},Ta=ae(()=>f("span",null," 刷新",-1)),Ea=["onClick"],Oa=["src"],Na={class:"text-[12px]"},La=["data-id"],za=["innerHTML"],Pa={key:0,class:"absolute left-[-20px] top-[10px] text-[#858585]"},Da={class:"relative"},Ba={class:"text-red-500 absolute top-[-10px] text-[12px] left-[4px] z-10 bg-white flex"},Aa=ae(()=>f("img",{src:$e,alt:"",srcset:""},null,-1)),Ma={class:"flex items-center"},Ra=ae(()=>f("div",{class:"wrapper"},[f("img",{src:Xt,class:"w-full",alt:"",srcset:""})],-1)),ja=Ge({__name:"chat",setup(e){const t=Je("chatId","");t.value=Ke().query.id;const n=Ce("socket");console.log($e);const{copy:h}=Xe({legacy:!0}),i=ue({msg:"",name:t.value=="1"?"小扈":"老胡",chatId:t.value,picImg:"",type:"text",msgId:""}),y=qe(),l=x(null),d=x(null),a=x([]),v=x(null),I=()=>{if(i.msg=="")return B.fail("请输入内容");i.type="text",i.msgId=new Date().getTime().toString(),n.emit("chat",i),a.value.push(JSON.parse(JSON.stringify(i))),i.msg="",b(!1)},b=s=>{nt(()=>{var _,$;V.to(l.value,{scrollTop:(_=l.value)==null?void 0:_.scrollHeight,duration:.3});let o=v.value[(($=v.value)==null?void 0:$.length)-1],u=s?-100:100;V.fromTo(o,{opacity:0,x:u},{opacity:1,duration:.3,x:0}),s&&Pe.observe(o)})};n.on("chat",s=>{a.value.push(s),b(!0)}),n.on("chatEnter",s=>{se.value=s.entering}),n.on("chatDelete",s=>{let o=a.value.findIndex(u=>u.msgId==s);a.value.splice(o,1)}),n.on("read",s=>{s.forEach(o=>{let u=a.value.findIndex(_=>_.msgId==(o.msgId||o));a.value[u].isRead=!0})});const L=s=>new Promise(o=>{const u=new FileReader;u.onloadend=_=>o(_.target.result),u.readAsDataURL(s)}),D=(s,o,u)=>new Promise(_=>s.toBlob($=>_($),o,u)),U=s=>new Promise(o=>{const u=new Image;u.onload=()=>o(u),u.src=s}),W=s=>{i.picImg=JSON.parse(s.responseText).data,i.msgId=new Date().getTime().toString(),n.emit("chat",i),d.value.clearUploadQueue(),i.picImg=""},A=s=>{B.fail(s)},z=async s=>{if(M(s[0])){i.type="img";let u=s[0].name;const _=document.createElement("canvas"),$=_.getContext("2d"),X=await L(s[0]),T=await U(X);_.width=T.width,_.height=T.height,$.clearRect(0,0,T.width,T.height),$.drawImage(T,0,0,T.width,T.height);let q=await D(_,"image/jpeg",.5);return[await new File([q],u)]}i.type="file";let o=await new File([s[0]],s[0].name);return console.log(o),[o]};function M(s){return s.type.startsWith("image/")}const Y=s=>{const o=document.createElement("a");o.href=s,o.download=s.slice(s.lastIndexOf("/"),s.length),o.click()};Qe(()=>{});const G=x(10),E=x(1),c=async()=>{let s=await ot.get("/chatList",{params:{pageSize:G.value,pageNum:E.value}});a.value.unshift(...s.data),k.value=!1,E.value==1&&setTimeout(()=>{V.to(l.value,{scrollTop:l.value.scrollHeight,duration:.5});let o=a.value.filter(u=>u.chatId!=t.value);o.length>0&&n.emit("read",o)},800),s.data.length==0&&Oe()};c();const k=x(!1),{y:S,directions:R}=Ze(l,{offset:{top:30,bottom:30,right:30,left:30}}),Te=Sa(async()=>{E.value++,await c(),S.value=400},500),Ee=()=>{E.value=1,a.value=[],c()},Oe=et(S,()=>{S.value<11&&R.top&&Te()}),J=x(!1),se=x(!1);let ne=null;const Ne=()=>{clearTimeout(ne),J.value||(J.value=!0,n.emit("chatEnter",{entering:!0})),ne=setTimeout(()=>{J.value=!1,n.emit("chatEnter",{entering:!1})},1500)},j=x(!1),F=x(!1),Le=ue([{name:"删除当条消息",type:"delete"},{name:"复制消息",type:"copy"}]),K=x(""),ze=async s=>{if(s.type=="delete")n.emit("chatDelete",K.value),B.success("删除成功");else{let o=a.value.find(u=>u.msgId==K.value);console.log(o);try{await h(o.msg||o.picImg),B.success("复制成功")}catch{B.fail("复制失败")}}},Pe=new IntersectionObserver(s=>{s.forEach(o=>{o.isIntersecting&&(console.log(de().format("YYYY-MM-DD HH:mm:ss")),console.log(y.value),y.value=="visible"&&n.emit("read",[o.target.dataset.id]))})},{});return(s,o)=>{const u=mt,_=Kt,$=me,X=dt,T=me,q=ut,oe=xt,De=Vt;return p(),g(ee,null,[w(u,{title:"小小聊天室",fixed:"",class:"bg-gray-300",onClickRight:o[0]||(o[0]=r=>j.value=!0),onClickBack:Ee},{left:C(()=>[f("div",$a,[Ta,w(m(ft),{width:"18px"})])]),right:C(()=>[w(m(bt),{class:"right",width:"18px"})]),_:1}),f("div",{style:{height:"calc(100vh - 96px)"},class:"overflow-y-auto overflow-x-hidden",ref_key:"chatBox",ref:l},[f("ul",null,[(p(!0),g(ee,null,ke(m(a),r=>(p(),g("li",{class:N(["flex mt-[10px] mb-[24px]",{"flex-row-reverse":r.chatId==m(t)}]),key:r.msgId},[w(_,{onClick:re=>{F.value=!0,K.value=r.msgId},class:"z-20 relative",color:"rgb(245, 106, 0)","bg-color":"rgb(253, 227, 207)"},{default:C(()=>[H(O(r.name),1)]),_:2},1032,["onClick"]),r.type=="img"?(p(),g("div",{key:0,onClick:re=>m(gt)({show:!0,images:[{src:r.picImg}]}),class:"mx-[12px]"},[f("img",{src:r.picImg,alt:"",srcset:""},null,8,Oa)],8,Ea)):r.type=="file"?(p(),g("div",{key:1,class:N(["flex items-center max-w-[82%] overflow-hidden",[r.chatId==m(t)?"mr-[12px]":"ml-[12px]"]])},[f("span",Na,"文件："+O(r.picImg.slice(r.picImg.lastIndexOf("/"),r.picImg.length)),1),w($,{size:"small",onClick:re=>Y(r.picImg)},{default:C(()=>[H("点击下载")]),_:2},1032,["onClick"])],2)):(p(),g("div",{key:2,ref_for:!0,ref_key:"chatList",ref:v,class:N(["bg-gray-100 rounded-lg text-[14px] max-w-[82%] p-[4px] relative z-10",[r.chatId==m(t)?"mr-[12px] ml-[12px]":"ml-[12px] mr-[12px] bg-green-500 text-white"]]),"data-id":r.msgId},[f("span",{class:"inline-block w-full overflow-hidden",innerHTML:r.msg},null,8,za),r.chatId==m(t)?(p(),g("span",Pa,[w(ge,{size:"18",icon:r.isRead?"ion:checkmark-done-outline":"ion:checkmark-outline"},null,8,["icon"])])):P("",!0),f("span",{class:N(["absolute text-[10px] text-gray-400 bottom-[-14px] whitespace-nowrap",[r.chatId==m(t)?"right-0":"left-0"]])},O(m(de)(r.time).format("MM-DD HH:mm:ss")),3)],10,La))],2))),128))])],512),f("div",Da,[tt(f("span",Ba,[H("对方正在输入中"),Aa],512),[[at,m(se)]]),w(q,{modelValue:m(i).msg,"onUpdate:modelValue":o[1]||(o[1]=r=>m(i).msg=r),onKeyup:st(I,["enter"]),onInput:Ne,placeholder:"请输入内容",clearable:""},{right:C(()=>[f("div",Ma,[w(X,{ref_key:"myUploader",ref:d,url:"/api/upload",onSuccess:W,"before-upload":z,onFailure:A,name:"image"},{default:C(()=>[w(m(rt),{name:"image",size:"24"})]),_:1},512),w(T,{style:{"margin-left":"10px"},type:"primary",size:"small",icon:"",onClick:I},{icon:C(()=>[w(ge,{icon:"ion:paper-plane-outline"})]),default:C(()=>[H("发送 ")]),_:1})])]),_:1},8,["modelValue","onKeyup"])]),w(oe,{visible:m(j),"onUpdate:visible":o[2]||(o[2]=r=>pe(j)?j.value=r:null)},{default:C(()=>[Ra]),_:1},8,["visible"]),w(De,{visible:m(F),"onUpdate:visible":o[3]||(o[3]=r=>pe(F)?F.value=r:null),"cancel-txt":"取消","menu-items":m(Le),onChoose:ze},null,8,["visible","menu-items"])],64)}}});const qa=ct(ja,[["__scopeId","data-v-cf810247"]]);export{qa as default};
