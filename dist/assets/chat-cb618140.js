import{K as Ue,L as We,o as m,d as v,l as z,n as D,e as h,P as Ye,$ as Ke,a6 as Je,_ as Ce,b as $e,as as Ge,h as pe,j as me,t as $,H as E,k as L,f as Se,F as Y,C as oe,N as Xe,i as Te,r as w,c as K,at as qe,au as Qe,av as Ze,aw as Ee,ad as et,m as Oe,a as ne,v as l,ax as tt,ae as st,af as at,ay as nt,az as ot,M as it,aA as lt,w as rt,p as fe,aB as ct,s as x,ab as ge,ak as ve,A as U,aC as ut,x as he,I as dt,z as pt,y as A,aD as mt,X as ft,Y as gt,a4 as se,aE as vt,J as _e,Z as ht}from"./index-13213bd5.js";import{i as _t}from"./index-1abbe959.js";/* empty css              */import{i as yt}from"./index-9e936fc5.js";import{g as ye,C as bt,i as xt,w as wt,s as It}from"./index-f99943a8.js";import"./Checked-77fadb42.js";import"./index-cp6Ms_Qe-5cb28148.js";import"./index-084nl_oE-b8b57d77.js";import"./raf-MQjoO-Ag-1373df64.js";const kt=We("horizontal-n"),Ct=h("path",{d:"M977.455 124.121H46.545C21.721 124.121 0 102.4 0 77.576S21.721 31.03 46.545 31.03h930.91c24.824 0 46.545 21.722 46.545 46.546s-21.721 46.545-46.545 46.545zm0 868.849H46.545C21.721 992.97 0 971.248 0 946.424s21.721-46.545 46.545-46.545h930.91c24.824 0 46.545 21.721 46.545 46.545s-21.721 46.546-46.545 46.546zm0-434.425H356.848c-24.824 0-46.545-21.72-46.545-46.545s21.721-46.545 46.545-46.545h620.607c24.824 0 46.545 21.72 46.545 46.545s-21.721 46.545-46.545 46.545z",fill:"currentColor","fill-opacity":"0.9"},null,-1),$t=[Ct];function St(e,t,n,_,i,g){return m(),v("svg",{class:z(e.classes),style:D(e.style),xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024",role:"presentation"},$t,6)}const Tt=Ue(kt,[["render",St]]);var Et=Object.defineProperty,Ot=Object.defineProperties,zt=Object.getOwnPropertyDescriptors,be=Object.getOwnPropertySymbols,Nt=Object.prototype.hasOwnProperty,jt=Object.prototype.propertyIsEnumerable,xe=(e,t,n)=>t in e?Et(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Lt=(e,t)=>{for(var n in t||(t={}))Nt.call(t,n)&&xe(e,n,t[n]);if(be)for(var n of be(t))jt.call(t,n)&&xe(e,n,t[n]);return e},Dt=(e,t)=>Ot(e,zt(t));const{create:Pt}=$e("action-sheet"),Rt=Pt({components:{NutPopup:Ye,Loading:Ke},props:Dt(Lt({},Ge),{cancelTxt:{type:String,default:""},optionTag:{type:String,default:"name"},optionSubTag:{type:String,default:"subname"},chooseTagValue:{type:String,default:""},title:{type:String,default:""},color:{type:String,default:"#ee0a24"},description:{type:String,default:""},menuItems:{type:Array,default:()=>[]},closeAbled:{type:Boolean,default:!0}}),emits:["cancel","close","choose","update:visible"],setup(e,{emit:t}){return{slotDefault:!!Je().default,isHighlight:o=>e.chooseTagValue&&e.chooseTagValue===o[e.optionTag]?e.color:"",cancelActionSheet:()=>{t("cancel"),t("update:visible",!1)},chooseItem:(o,u)=>{!o.disable&&!o.loading&&(t("choose",o,u),t("update:visible",!1))},close:o=>{e.closeAbled&&(t("close",o),t("update:visible",!1))}}}}),At={class:"nut-action-sheet"},Ht={key:0,class:"nut-action-sheet__title"},Mt={key:1},Bt={key:0,class:"nut-action-sheet__item nut-action-sheet__desc"},Vt={key:1,class:"nut-action-sheet__menu"},Ft=["onClick"],Ut={key:1},Wt={class:"nut-action-sheet__subdesc"};function Yt(e,t,n,_,i,g){const d=pe("Loading"),o=pe("nut-popup");return m(),me(o,{visible:e.visible,position:"bottom",round:"","close-on-click-overlay":e.closeAbled,"lock-scroll":e.lockScroll,"z-index":e.zIndex,onClickOverlay:e.close},{default:$(()=>[h("view",At,[e.title?(m(),v("view",Ht,E(e.title),1)):L("",!0),Se(e.$slots,"default"),e.slotDefault?L("",!0):(m(),v("view",Mt,[e.description?(m(),v("view",Bt,E(e.description),1)):L("",!0),e.menuItems.length?(m(),v("view",Vt,[(m(!0),v(Y,null,oe(e.menuItems,(u,p)=>(m(),v("view",{key:p,class:z(["nut-action-sheet__item",{"nut-action-sheet__item--disabled":u.disable,"nut-action-sheet__item--loading":u.loading}]),style:D({color:e.isHighlight(u)||u.color}),onClick:I=>e.chooseItem(u,p)},[u.loading?(m(),me(d,{key:0})):(m(),v("view",Ut,E(u[e.optionTag]),1)),h("view",Wt,E(u[e.optionSubTag]),1)],14,Ft))),128))])):L("",!0),e.cancelTxt?(m(),v("view",{key:2,class:"nut-action-sheet__cancel",onClick:t[0]||(t[0]=(...u)=>e.cancelActionSheet&&e.cancelActionSheet(...u))},E(e.cancelTxt),1)):L("",!0)]))])]),_:3},8,["visible","close-on-click-overlay","lock-scroll","z-index","onClickOverlay"])}const Kt=Ce(Rt,[["render",Yt]]),Jt=Symbol("nut-avatar"),{create:Gt}=$e("avatar"),Xt=Gt({props:{size:{type:[String,Number],default:"normal"},shape:{type:String,default:"round"},bgColor:{type:String,default:"#eee"},color:{type:String,default:"#666"}},setup(e){const{size:t,shape:n,bgColor:_,color:i}=Xe(e),g=["large","normal","small"],d=Te(Jt,null),o=w(null),u=K(()=>{var I,y;return{["nut-avatar"]:!0,[`nut-avatar-${t.value||((I=d==null?void 0:d.props)==null?void 0:I.size)||"normal"}`]:!0,[`nut-avatar-${n.value||((y=d==null?void 0:d.props)==null?void 0:y.shape)||"round"}`]:!0}}),p=K(()=>{var I,y;return{width:t.value in g?"":`${t.value}px`,height:t.value in g?"":`${t.value}px`,backgroundColor:`${_.value}`,color:`${i.value}`,marginLeft:(I=d==null?void 0:d.props)!=null&&I.span?`${(y=d==null?void 0:d.props)==null?void 0:y.span}px`:""}});return{classes:u,styles:p,avatarRef:o}}});function qt(e,t,n,_,i,g){return m(),v("view",{ref:"avatarRef",style:D(e.styles),class:z(e.classes)},[Se(e.$slots,"default")],6)}const Qt=Ce(Xt,[["render",qt]]);const Zt="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ccircle cx='18' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='.67' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3Ccircle cx='12' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='.33' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3Ccircle cx='6' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='0' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3C!-- 1701252868811 --%3E%3C/svg%3E",ze=Zt,es=""+new URL("chatBg-cdb6162e.jpg",import.meta.url).href;var ts=qe,ss=function(){return ts.Date.now()},as=ss,ns=/\s/;function os(e){for(var t=e.length;t--&&ns.test(e.charAt(t)););return t}var is=os,ls=is,rs=/^\s+/;function cs(e){return e&&e.slice(0,ls(e)+1).replace(rs,"")}var us=cs,ds=Qe,ps=Ze,ms="[object Symbol]";function fs(e){return typeof e=="symbol"||ps(e)&&ds(e)==ms}var gs=fs,vs=us,we=Ee,hs=gs,Ie=0/0,_s=/^[-+]0x[0-9a-f]+$/i,ys=/^0b[01]+$/i,bs=/^0o[0-7]+$/i,xs=parseInt;function ws(e){if(typeof e=="number")return e;if(hs(e))return Ie;if(we(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=we(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=vs(e);var n=ys.test(e);return n||bs.test(e)?xs(e.slice(2),n?2:8):_s.test(e)?Ie:+e}var Is=ws,ks=Ee,ae=as,ke=Is,Cs="Expected a function",$s=Math.max,Ss=Math.min;function Ts(e,t,n){var _,i,g,d,o,u,p=0,I=!1,y=!1,O=!0;if(typeof e!="function")throw new TypeError(Cs);t=ke(t)||0,ks(n)&&(I=!!n.leading,y="maxWait"in n,g=y?$s(ke(n.maxWait)||0,t):g,O="trailing"in n?!!n.trailing:O);function N(f){var k=_,C=i;return _=i=void 0,p=f,d=e.apply(C,k),d}function H(f){return p=f,o=setTimeout(j,t),I?N(f):d}function J(f){var k=f-u,C=f-p,R=t-k;return y?Ss(R,g-C):R}function M(f){var k=f-u,C=f-p;return u===void 0||k>=t||k<0||y&&C>=g}function j(){var f=ae();if(M(f))return B(f);o=setTimeout(j,J(f))}function B(f){return o=void 0,O&&_?N(f):(_=i=void 0,d)}function G(){o!==void 0&&clearTimeout(o),p=0,_=u=i=o=void 0}function X(){return o===void 0?d:B(ae())}function P(){var f=ae(),k=M(f);if(_=arguments,i=this,u=f,k){if(o===void 0)return H(u);if(y)return clearTimeout(o),o=setTimeout(j,t),N(u)}return o===void 0&&(o=setTimeout(j,t)),d}return P.cancel=G,P.flush=X,P}var Es=Ts;const Os=et(Es);var W=ye.registerPlugin(bt)||ye;W.core.Tween;const zs={class:"w-full bg-[#f4f4f4] z-50"},Ns={class:"grid grid-cols-8 gap-[4px] py-[4px]"},js=["onClick"],Ls=Oe({__name:"emoji",emits:["emojiClick"],setup(e,{emit:t}){const n=ne(["😀","😄","😆","😅","🤣","😂","🥰","🤩","😘","🥲","😋","🫢","🫣","😝","🫡","🤔","🤨","😑","😏","🙄","😮‍💨","😌","😔","😪","🤒","😎","🤓","🧐","😟","🥹","😳","😠","😵‍💫","🤤","👍","✊","🙏","🤝","👀"]);return(_,i)=>(m(),v("div",zs,[h("div",Ns,[(m(!0),v(Y,null,oe(l(n),(g,d)=>(m(),v("div",{key:d,class:"text-center text-[24px] cursor-pointer",onClick:o=>_.$emit("emojiClick",g)},E(g),9,js))),128))])]))}}),ie=e=>(ft("data-v-8c76bbe8"),e=e(),gt(),e),Ds={class:"flex items-center"},Ps=ie(()=>h("span",null," 刷新",-1)),Rs=["onClick"],As=["src"],Hs={class:"text-[12px]"},Ms=["data-id"],Bs=["innerHTML"],Vs={key:0,class:"absolute left-[-20px] top-[10px] text-[#858585]"},Fs={class:"text-red-500 absolute top-[-10px] text-[12px] left-[4px] z-10 bg-white flex"},Us=ie(()=>h("img",{src:ze,alt:"",srcset:""},null,-1)),Ws={class:"flex items-center"},Ys=ie(()=>h("div",{class:"wrapper"},[h("img",{src:es,class:"w-full",alt:"",srcset:""})],-1)),Ks=Oe({__name:"chat",setup(e){tt(s=>({"57b5f2fe":l(y),"619e16a3":l(O)}));const t=st("chatId","");t.value=at().query.id;const n=Te("socket");console.log(ze);const{copy:_}=nt({legacy:!0}),i=ne({msg:"",name:t.value=="1"?"小扈":"老胡",chatId:t.value,picImg:"",type:"text",msgId:""}),g=w(!1),d=ot(),o=w(null),u=w(null),p=w([]),I=w(null),y=K(()=>t.value=="2"?"#282828":"#fff"),O=K(()=>t.value=="2"?"#ccc":"#000"),N=()=>{if(i.msg=="")return A.fail("请输入内容");i.type="text",i.msgId=new Date().getTime().toString(),n.emit("chat",i),p.value.push(JSON.parse(JSON.stringify(i))),i.msg="",H(!1)},H=s=>{dt(()=>{var b,S;W.to(o.value,{scrollTop:(b=o.value)==null?void 0:b.scrollHeight,duration:.3});let a=I.value[((S=I.value)==null?void 0:S.length)-1],c=s?-100:100;W.fromTo(a,{opacity:0,x:c},{opacity:1,duration:.3,x:0}),s&&Me.observe(a)})};n.on("chat",s=>{p.value.push(s),H(!0),d.value!="visible"&&t.value=="2"&&alert("有消息了")}),n.on("chatEnter",s=>{le.value=s.entering}),n.on("chatDelete",s=>{let a=p.value.findIndex(c=>c.msgId==s);p.value.splice(a,1)}),n.on("read",s=>{s.forEach(a=>{let c=p.value.findIndex(b=>b.msgId==(a.msgId||a));p.value[c].isRead=!0})});const J=s=>new Promise(a=>{const c=new FileReader;c.onloadend=b=>a(b.target.result),c.readAsDataURL(s)}),M=(s,a,c)=>new Promise(b=>s.toBlob(S=>b(S),a,c)),j=s=>new Promise(a=>{const c=new Image;c.onload=()=>a(c),c.src=s}),B=s=>{i.picImg=JSON.parse(s.responseText).data,i.msgId=new Date().getTime().toString(),n.emit("chat",i),u.value.clearUploadQueue(),i.picImg=""},G=s=>{A.fail(s)},X=async s=>{if(P(s[0])){i.type="img";let c=s[0].name;const b=document.createElement("canvas"),S=b.getContext("2d"),ee=await J(s[0]),T=await j(ee);b.width=T.width,b.height=T.height,S.clearRect(0,0,T.width,T.height),S.drawImage(T,0,0,T.width,T.height);let te=await M(b,"image/jpeg",.5);return[await new File([te],c)]}i.type="file";let a=await new File([s[0]],s[0].name);return console.log(a),[a]};function P(s){return s.type.startsWith("image/")}const f=s=>{const a=document.createElement("a");a.href=s,a.download=s.slice(s.lastIndexOf("/"),s.length),a.click()};it(()=>{});const k=w(20),C=w(1),R=async()=>{let s=await pt.get("/chatList",{params:{pageSize:k.value,pageNum:C.value}});p.value.unshift(...s.data),Ne.value=!1,C.value==1&&setTimeout(()=>{W.to(o.value,{scrollTop:o.value.scrollHeight,duration:.5});let a=p.value.filter(c=>c.chatId!=t.value);a.length>0&&n.emit("read",a)},500),s.data.length==0&&Pe()};R();const Ne=w(!1),{y:q,directions:je}=lt(o,{offset:{top:30,bottom:30,right:30,left:30}}),Le=Os(async()=>{var a,c;C.value++;let s=(a=o.value)==null?void 0:a.scrollHeight;await R(),q.value=((c=o.value)==null?void 0:c.scrollHeight)-s-10},500),De=()=>{C.value=0,p.value=[]},Pe=rt(q,()=>{q.value<11&&je.top&&Le()}),Q=w(!1),le=w(!1);let re=null;const Re=()=>{clearTimeout(re),Q.value||(Q.value=!0,n.emit("chatEnter",{entering:!0})),re=setTimeout(()=>{Q.value=!1,n.emit("chatEnter",{entering:!1})},3e3)},V=w(!1),F=w(!1),Ae=ne([{name:"删除当条消息",type:"delete"},{name:"复制消息",type:"copy"}]),Z=w(""),He=async s=>{if(s.type=="delete")n.emit("chatDelete",Z.value),A.success("删除成功");else{let a=p.value.find(c=>c.msgId==Z.value);console.log(a);try{await _(a.msg||a.picImg),A.success("复制成功")}catch{A.fail("复制失败")}}},Me=new IntersectionObserver(s=>{s.forEach(a=>{a.isIntersecting&&(console.log(fe().format("YYYY-MM-DD HH:mm:ss")),console.log(d.value),d.value=="visible"&&n.emit("read",[a.target.dataset.id]))})},{}),Be=s=>{i.msg=i.msg+s},ce=w(null);ct(ce,()=>{g.value&&(g.value=!1)});const Ve=()=>{g.value||(g.value=!0)};return(s,a)=>{const c=xt,b=Qt,S=_e,ee=yt,T=_e,te=_t,ue=mt,Fe=Kt;return m(),v(Y,null,[x(c,{title:"小小聊天室",fixed:"",style:{background:"#000"},onClickRight:a[0]||(a[0]=r=>V.value=!0),onClickBack:De,border:!1},{left:$(()=>[h("div",Ds,[Ps,x(l(wt),{width:"18px"})])]),right:$(()=>[x(l(Tt),{class:"right",width:"18px"})]),_:1}),h("div",{style:D([{height:"calc(100vh - 96px)"},{background:l(y)}]),class:"overflow-y-auto overflow-x-hidden",ref_key:"chatBox",ref:o},[h("ul",null,[(m(!0),v(Y,null,oe(l(p),r=>(m(),v("li",{class:z(["flex mt-[10px] mb-[24px]",{"flex-row-reverse":r.chatId==l(t)}]),key:r.msgId},[x(b,{onClick:de=>{F.value=!0,Z.value=r.msgId},class:"z-20 relative",color:l(t)=="2"?l(O):"rgb(245, 106, 0)","bg-color":l(t)=="2"?l(y):"rgb(253, 227, 207)"},{default:$(()=>[U(E(r.name),1)]),_:2},1032,["onClick","color","bg-color"]),r.type=="img"?(m(),v("div",{key:0,onClick:de=>l(It)({show:!0,images:[{src:r.picImg}]}),class:"mx-[12px]"},[h("img",{src:r.picImg,alt:"",srcset:""},null,8,As)],8,Rs)):r.type=="file"?(m(),v("div",{key:1,class:z(["flex items-center max-w-[82%] overflow-hidden",[r.chatId==l(t)?"mr-[12px]":"ml-[12px]"]])},[h("span",Hs,"文件："+E(r.picImg.slice(r.picImg.lastIndexOf("/"),r.picImg.length)),1),x(S,{size:"small",onClick:de=>f(r.picImg)},{default:$(()=>[U("点击下载")]),_:2},1032,["onClick"])],2)):(m(),v("div",{key:2,ref_for:!0,ref_key:"chatList",ref:I,class:z(["bg-gray-100 rounded-lg text-[14px] max-w-[82%] p-[4px] relative z-10",[r.chatId==l(t)?"mr-[12px] ml-[12px]":"ml-[12px] mr-[12px] bg-green-500 text-white"]]),"data-id":r.msgId,style:D({background:l(t)=="2"?"#000":"",color:l(t)=="2"?"#ccc":""})},[h("span",{class:"inline-block w-full overflow-hidden",innerHTML:r.msg},null,8,Bs),r.chatId==l(t)?(m(),v("span",Vs,[x(se,{size:"18",icon:r.isRead?"ion:checkmark-done-outline":"ion:checkmark-outline"},null,8,["icon"])])):L("",!0),h("span",{class:z(["absolute text-[10px] text-gray-400 bottom-[-14px] whitespace-nowrap",[r.chatId==l(t)?"right-0":"left-0"]])},E(l(fe)(r.time).format("MM-DD HH:mm:ss")),3)],14,Ms))],2))),128))])],4),h("div",{class:"relative",style:D({background:l(y)})},[ge(h("span",Fs,[U("对方正在输入中"),Us],512),[[ve,l(le)]]),x(te,{modelValue:l(i).msg,"onUpdate:modelValue":a[1]||(a[1]=r=>l(i).msg=r),onKeyup:ut(N,["enter"]),onInput:Re,placeholder:"请输入内容",clearable:""},{right:$(()=>[h("div",Ws,[x(se,{icon:"carbon:face-wink",size:"24",class:"mr-[10px] cursor-pointer",onClick:Ve}),x(ee,{ref_key:"myUploader",ref:u,url:"/api/upload",onSuccess:B,"before-upload":X,onFailure:G,name:"image"},{default:$(()=>[x(l(vt),{name:"image",size:"24"})]),_:1},512),x(T,{style:{"margin-left":"10px"},type:"primary",size:"small",icon:"",onClick:N},{icon:$(()=>[x(se,{icon:"ion:paper-plane-outline"})]),default:$(()=>[U("发送 ")]),_:1})])]),_:1},8,["modelValue","onKeyup"]),ge(x(Ls,{ref_key:"emojiRef",ref:ce,onEmojiClick:Be,class:"absolute top-[-200px]"},null,512),[[ve,l(g)]])],4),x(ue,{visible:l(V),"onUpdate:visible":a[2]||(a[2]=r=>he(V)?V.value=r:null)},{default:$(()=>[Ys]),_:1},8,["visible"]),x(Fe,{visible:l(F),"onUpdate:visible":a[3]||(a[3]=r=>he(F)?F.value=r:null),"cancel-txt":"取消","menu-items":l(Ae),onChoose:He},null,8,["visible","menu-items"])],64)}}});const aa=ht(Ks,[["__scopeId","data-v-8c76bbe8"]]);export{aa as default};
