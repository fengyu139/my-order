import{J as Pe,K as Ae,o as p,d as g,l as N,n as ee,e as f,O as He,$ as Be,a6 as Me,_ as be,b as xe,as as Re,h as ie,j as le,t as S,H as O,k as D,f as we,F as Z,C as Ie,L as je,i as ke,r as w,c as re,at as Fe,au as Ve,av as Ue,aw as Se,ad as We,m as Ye,ae as Ke,af as Je,ax as Ge,a as ce,ay as Qe,Q as Xe,az as qe,w as Ze,p as ue,s as x,v as m,ab as et,ak as tt,A as F,aA as at,x as de,I as nt,z as st,y as A,aB as ot,X as it,Y as lt,a4 as pe,aC as rt,N as me,Z as ct}from"./index-41545bf3.js";import{i as ut}from"./index-40d349c6.js";/* empty css              */import{i as dt}from"./index-b4796ca3.js";import{g as fe,C as pt,i as mt,w as ft,s as gt}from"./index-d30160eb.js";import"./Checked-1a6cc4a9.js";import"./index-rf29bejW-80e40bdd.js";import"./index-084nl_oE-2c6c929b.js";import"./raf-MQjoO-Ag-f7e6c7b1.js";const vt=Ae("horizontal-n"),ht=f("path",{d:"M977.455 124.121H46.545C21.721 124.121 0 102.4 0 77.576S21.721 31.03 46.545 31.03h930.91c24.824 0 46.545 21.722 46.545 46.546s-21.721 46.545-46.545 46.545zm0 868.849H46.545C21.721 992.97 0 971.248 0 946.424s21.721-46.545 46.545-46.545h930.91c24.824 0 46.545 21.721 46.545 46.545s-21.721 46.546-46.545 46.546zm0-434.425H356.848c-24.824 0-46.545-21.72-46.545-46.545s21.721-46.545 46.545-46.545h620.607c24.824 0 46.545 21.72 46.545 46.545s-21.721 46.545-46.545 46.545z",fill:"currentColor","fill-opacity":"0.9"},null,-1),_t=[ht];function yt(e,t,s,_,c,v){return p(),g("svg",{class:N(e.classes),style:ee(e.style),xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024",role:"presentation"},_t,6)}const bt=Pe(vt,[["render",yt]]);var xt=Object.defineProperty,wt=Object.defineProperties,It=Object.getOwnPropertyDescriptors,ge=Object.getOwnPropertySymbols,kt=Object.prototype.hasOwnProperty,St=Object.prototype.propertyIsEnumerable,ve=(e,t,s)=>t in e?xt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,Ct=(e,t)=>{for(var s in t||(t={}))kt.call(t,s)&&ve(e,s,t[s]);if(ge)for(var s of ge(t))St.call(t,s)&&ve(e,s,t[s]);return e},$t=(e,t)=>wt(e,It(t));const{create:Tt}=xe("action-sheet"),Et=Tt({components:{NutPopup:He,Loading:Be},props:$t(Ct({},Re),{cancelTxt:{type:String,default:""},optionTag:{type:String,default:"name"},optionSubTag:{type:String,default:"subname"},chooseTagValue:{type:String,default:""},title:{type:String,default:""},color:{type:String,default:"#ee0a24"},description:{type:String,default:""},menuItems:{type:Array,default:()=>[]},closeAbled:{type:Boolean,default:!0}}),emits:["cancel","close","choose","update:visible"],setup(e,{emit:t}){return{slotDefault:!!Me().default,isHighlight:l=>e.chooseTagValue&&e.chooseTagValue===l[e.optionTag]?e.color:"",cancelActionSheet:()=>{t("cancel"),t("update:visible",!1)},chooseItem:(l,o)=>{!l.disable&&!l.loading&&(t("choose",l,o),t("update:visible",!1))},close:l=>{e.closeAbled&&(t("close",l),t("update:visible",!1))}}}}),Ot={class:"nut-action-sheet"},Nt={key:0,class:"nut-action-sheet__title"},zt={key:1},Lt={key:0,class:"nut-action-sheet__item nut-action-sheet__desc"},Dt={key:1,class:"nut-action-sheet__menu"},Pt=["onClick"],At={key:1},Ht={class:"nut-action-sheet__subdesc"};function Bt(e,t,s,_,c,v){const i=ie("Loading"),l=ie("nut-popup");return p(),le(l,{visible:e.visible,position:"bottom",round:"","close-on-click-overlay":e.closeAbled,"lock-scroll":e.lockScroll,"z-index":e.zIndex,onClickOverlay:e.close},{default:S(()=>[f("view",Ot,[e.title?(p(),g("view",Nt,O(e.title),1)):D("",!0),we(e.$slots,"default"),e.slotDefault?D("",!0):(p(),g("view",zt,[e.description?(p(),g("view",Lt,O(e.description),1)):D("",!0),e.menuItems.length?(p(),g("view",Dt,[(p(!0),g(Z,null,Ie(e.menuItems,(o,y)=>(p(),g("view",{key:y,class:N(["nut-action-sheet__item",{"nut-action-sheet__item--disabled":o.disable,"nut-action-sheet__item--loading":o.loading}]),style:ee({color:e.isHighlight(o)||o.color}),onClick:I=>e.chooseItem(o,y)},[o.loading?(p(),le(i,{key:0})):(p(),g("view",At,O(o[e.optionTag]),1)),f("view",Ht,O(o[e.optionSubTag]),1)],14,Pt))),128))])):D("",!0),e.cancelTxt?(p(),g("view",{key:2,class:"nut-action-sheet__cancel",onClick:t[0]||(t[0]=(...o)=>e.cancelActionSheet&&e.cancelActionSheet(...o))},O(e.cancelTxt),1)):D("",!0)]))])]),_:3},8,["visible","close-on-click-overlay","lock-scroll","z-index","onClickOverlay"])}const Mt=be(Et,[["render",Bt]]),Rt=Symbol("nut-avatar"),{create:jt}=xe("avatar"),Ft=jt({props:{size:{type:[String,Number],default:"normal"},shape:{type:String,default:"round"},bgColor:{type:String,default:"#eee"},color:{type:String,default:"#666"}},setup(e){const{size:t,shape:s,bgColor:_,color:c}=je(e),v=["large","normal","small"],i=ke(Rt,null),l=w(null),o=re(()=>{var I,b;return{["nut-avatar"]:!0,[`nut-avatar-${t.value||((I=i==null?void 0:i.props)==null?void 0:I.size)||"normal"}`]:!0,[`nut-avatar-${s.value||((b=i==null?void 0:i.props)==null?void 0:b.shape)||"round"}`]:!0}}),y=re(()=>{var I,b;return{width:t.value in v?"":`${t.value}px`,height:t.value in v?"":`${t.value}px`,backgroundColor:`${_.value}`,color:`${c.value}`,marginLeft:(I=i==null?void 0:i.props)!=null&&I.span?`${(b=i==null?void 0:i.props)==null?void 0:b.span}px`:""}});return{classes:o,styles:y,avatarRef:l}}});function Vt(e,t,s,_,c,v){return p(),g("view",{ref:"avatarRef",style:ee(e.styles),class:N(e.classes)},[we(e.$slots,"default")],6)}const Ut=be(Ft,[["render",Vt]]);const Wt="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ccircle cx='18' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='.67' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3Ccircle cx='12' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='.33' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3Ccircle cx='6' cy='12' r='0' fill='red'%3E%3Canimate attributeName='r' begin='0' calcMode='spline' dur='1.5s' keySplines='0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8' repeatCount='indefinite' values='0;2;0;0'/%3E%3C/circle%3E%3C!-- 1701252868811 --%3E%3C/svg%3E",Ce=Wt,Yt=""+new URL("chatBg-91517f37.jpg",import.meta.url).href;var Kt=Fe,Jt=function(){return Kt.Date.now()},Gt=Jt,Qt=/\s/;function Xt(e){for(var t=e.length;t--&&Qt.test(e.charAt(t)););return t}var qt=Xt,Zt=qt,ea=/^\s+/;function ta(e){return e&&e.slice(0,Zt(e)+1).replace(ea,"")}var aa=ta,na=Ve,sa=Ue,oa="[object Symbol]";function ia(e){return typeof e=="symbol"||sa(e)&&na(e)==oa}var la=ia,ra=aa,he=Se,ca=la,_e=0/0,ua=/^[-+]0x[0-9a-f]+$/i,da=/^0b[01]+$/i,pa=/^0o[0-7]+$/i,ma=parseInt;function fa(e){if(typeof e=="number")return e;if(ca(e))return _e;if(he(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=he(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=ra(e);var s=da.test(e);return s||pa.test(e)?ma(e.slice(2),s?2:8):ua.test(e)?_e:+e}var ga=fa,va=Se,q=Gt,ye=ga,ha="Expected a function",_a=Math.max,ya=Math.min;function ba(e,t,s){var _,c,v,i,l,o,y=0,I=!1,b=!1,z=!0;if(typeof e!="function")throw new TypeError(ha);t=ye(t)||0,va(s)&&(I=!!s.leading,b="maxWait"in s,v=b?_a(ye(s.maxWait)||0,t):v,z="trailing"in s?!!s.trailing:z);function P(d){var k=_,C=c;return _=c=void 0,y=d,i=e.apply(C,k),i}function U(d){return y=d,l=setTimeout(L,t),I?P(d):i}function W(d){var k=d-o,C=d-y,M=t-k;return b?ya(M,v-C):M}function H(d){var k=d-o,C=d-y;return o===void 0||k>=t||k<0||b&&C>=v}function L(){var d=q();if(H(d))return B(d);l=setTimeout(L,W(d))}function B(d){return l=void 0,z&&_?P(d):(_=c=void 0,i)}function Y(){l!==void 0&&clearTimeout(l),y=0,_=o=c=l=void 0}function K(){return l===void 0?i:B(q())}function E(){var d=q(),k=H(d);if(_=arguments,c=this,o=d,k){if(l===void 0)return U(o);if(b)return clearTimeout(l),l=setTimeout(L,t),P(o)}return l===void 0&&(l=setTimeout(L,t)),i}return E.cancel=Y,E.flush=K,E}var xa=ba;const wa=We(xa);var V=fe.registerPlugin(pt)||fe;V.core.Tween;const te=e=>(it("data-v-63de96dd"),e=e(),lt(),e),Ia={class:"flex items-center"},ka=te(()=>f("span",null," 刷新",-1)),Sa=["onClick"],Ca=["src"],$a={class:"text-[12px]"},Ta=["data-id"],Ea=["innerHTML"],Oa={key:0,class:"absolute left-[-20px] top-[10px] text-[#858585]"},Na={class:"relative"},za={class:"text-red-500 absolute top-[-10px] text-[12px] left-[4px] z-10 bg-white flex"},La=te(()=>f("img",{src:Ce,alt:"",srcset:""},null,-1)),Da={class:"flex items-center"},Pa=te(()=>f("div",{class:"wrapper"},[f("img",{src:Yt,class:"w-full",alt:"",srcset:""})],-1)),Aa=Ye({__name:"chat",setup(e){const t=Ke("chatId","");t.value=Je().query.id;const s=ke("socket");console.log(Ce);const{copy:_}=Ge({legacy:!0}),c=ce({msg:"",name:t.value=="1"?"小扈":"老胡",chatId:t.value,picImg:"",type:"text",msgId:""}),v=Qe(),i=w(null),l=w(null),o=w([]),y=w(null),I=()=>{if(c.msg=="")return A.fail("请输入内容");c.type="text",c.msgId=new Date().getTime().toString(),s.emit("chat",c),o.value.push(JSON.parse(JSON.stringify(c))),c.msg="",b(!1)},b=a=>{nt(()=>{var h,$;V.to(i.value,{scrollTop:(h=i.value)==null?void 0:h.scrollHeight,duration:.3});let n=y.value[(($=y.value)==null?void 0:$.length)-1],u=a?-100:100;V.fromTo(n,{opacity:0,x:u},{opacity:1,duration:.3,x:0}),a&&Le.observe(n)})};s.on("chat",a=>{o.value.push(a),b(!0),v.value!="visible"&&t.value=="2"&&alert("有消息了")}),s.on("chatEnter",a=>{ae.value=a.entering}),s.on("chatDelete",a=>{let n=o.value.findIndex(u=>u.msgId==a);o.value.splice(n,1)}),s.on("read",a=>{a.forEach(n=>{let u=o.value.findIndex(h=>h.msgId==(n.msgId||n));o.value[u].isRead=!0})});const z=a=>new Promise(n=>{const u=new FileReader;u.onloadend=h=>n(h.target.result),u.readAsDataURL(a)}),P=(a,n,u)=>new Promise(h=>a.toBlob($=>h($),n,u)),U=a=>new Promise(n=>{const u=new Image;u.onload=()=>n(u),u.src=a}),W=a=>{c.picImg=JSON.parse(a.responseText).data,c.msgId=new Date().getTime().toString(),s.emit("chat",c),l.value.clearUploadQueue(),c.picImg=""},H=a=>{A.fail(a)},L=async a=>{if(B(a[0])){c.type="img";let u=a[0].name;const h=document.createElement("canvas"),$=h.getContext("2d"),Q=await z(a[0]),T=await U(Q);h.width=T.width,h.height=T.height,$.clearRect(0,0,T.width,T.height),$.drawImage(T,0,0,T.width,T.height);let X=await P(h,"image/jpeg",.5);return[await new File([X],u)]}c.type="file";let n=await new File([a[0]],a[0].name);return console.log(n),[n]};function B(a){return a.type.startsWith("image/")}const Y=a=>{const n=document.createElement("a");n.href=a,n.download=a.slice(a.lastIndexOf("/"),a.length),n.click()};Xe(()=>{});const K=w(20),E=w(1),d=async()=>{let a=await st.get("/chatList",{params:{pageSize:K.value,pageNum:E.value}});o.value.unshift(...a.data),k.value=!1,E.value==1&&setTimeout(()=>{V.to(i.value,{scrollTop:i.value.scrollHeight,duration:.5});let n=o.value.filter(u=>u.chatId!=t.value);n.length>0&&s.emit("read",n)},500),a.data.length==0&&Ee()};d();const k=w(!1),{y:C,directions:M}=qe(i,{offset:{top:30,bottom:30,right:30,left:30}}),$e=wa(async()=>{var n,u;E.value++;let a=(n=i.value)==null?void 0:n.scrollHeight;await d(),C.value=((u=i.value)==null?void 0:u.scrollHeight)-a-10},500),Te=()=>{E.value=0,o.value=[]},Ee=Ze(C,()=>{C.value<11&&M.top&&$e()}),J=w(!1),ae=w(!1);let ne=null;const Oe=()=>{clearTimeout(ne),J.value||(J.value=!0,s.emit("chatEnter",{entering:!0})),ne=setTimeout(()=>{J.value=!1,s.emit("chatEnter",{entering:!1})},1500)},R=w(!1),j=w(!1),Ne=ce([{name:"删除当条消息",type:"delete"},{name:"复制消息",type:"copy"}]),G=w(""),ze=async a=>{if(a.type=="delete")s.emit("chatDelete",G.value),A.success("删除成功");else{let n=o.value.find(u=>u.msgId==G.value);console.log(n);try{await _(n.msg||n.picImg),A.success("复制成功")}catch{A.fail("复制失败")}}},Le=new IntersectionObserver(a=>{a.forEach(n=>{n.isIntersecting&&(console.log(ue().format("YYYY-MM-DD HH:mm:ss")),console.log(v.value),v.value=="visible"&&s.emit("read",[n.target.dataset.id]))})},{});return(a,n)=>{const u=mt,h=Ut,$=me,Q=dt,T=me,X=ut,se=ot,De=Mt;return p(),g(Z,null,[x(u,{title:"小小聊天室",fixed:"",class:"bg-gray-300",onClickRight:n[0]||(n[0]=r=>R.value=!0),onClickBack:Te},{left:S(()=>[f("div",Ia,[ka,x(m(ft),{width:"18px"})])]),right:S(()=>[x(m(bt),{class:"right",width:"18px"})]),_:1}),f("div",{style:{height:"calc(100vh - 96px)"},class:"overflow-y-auto overflow-x-hidden",ref_key:"chatBox",ref:i},[f("ul",null,[(p(!0),g(Z,null,Ie(m(o),r=>(p(),g("li",{class:N(["flex mt-[10px] mb-[24px]",{"flex-row-reverse":r.chatId==m(t)}]),key:r.msgId},[x(h,{onClick:oe=>{j.value=!0,G.value=r.msgId},class:"z-20 relative",color:"rgb(245, 106, 0)","bg-color":"rgb(253, 227, 207)"},{default:S(()=>[F(O(r.name),1)]),_:2},1032,["onClick"]),r.type=="img"?(p(),g("div",{key:0,onClick:oe=>m(gt)({show:!0,images:[{src:r.picImg}]}),class:"mx-[12px]"},[f("img",{src:r.picImg,alt:"",srcset:""},null,8,Ca)],8,Sa)):r.type=="file"?(p(),g("div",{key:1,class:N(["flex items-center max-w-[82%] overflow-hidden",[r.chatId==m(t)?"mr-[12px]":"ml-[12px]"]])},[f("span",$a,"文件："+O(r.picImg.slice(r.picImg.lastIndexOf("/"),r.picImg.length)),1),x($,{size:"small",onClick:oe=>Y(r.picImg)},{default:S(()=>[F("点击下载")]),_:2},1032,["onClick"])],2)):(p(),g("div",{key:2,ref_for:!0,ref_key:"chatList",ref:y,class:N(["bg-gray-100 rounded-lg text-[14px] max-w-[82%] p-[4px] relative z-10",[r.chatId==m(t)?"mr-[12px] ml-[12px]":"ml-[12px] mr-[12px] bg-green-500 text-white"]]),"data-id":r.msgId},[f("span",{class:"inline-block w-full overflow-hidden",innerHTML:r.msg},null,8,Ea),r.chatId==m(t)?(p(),g("span",Oa,[x(pe,{size:"18",icon:r.isRead?"ion:checkmark-done-outline":"ion:checkmark-outline"},null,8,["icon"])])):D("",!0),f("span",{class:N(["absolute text-[10px] text-gray-400 bottom-[-14px] whitespace-nowrap",[r.chatId==m(t)?"right-0":"left-0"]])},O(m(ue)(r.time).format("MM-DD HH:mm:ss")),3)],10,Ta))],2))),128))])],512),f("div",Na,[et(f("span",za,[F("对方正在输入中"),La],512),[[tt,m(ae)]]),x(X,{modelValue:m(c).msg,"onUpdate:modelValue":n[1]||(n[1]=r=>m(c).msg=r),onKeyup:at(I,["enter"]),onInput:Oe,placeholder:"请输入内容",clearable:""},{right:S(()=>[f("div",Da,[x(Q,{ref_key:"myUploader",ref:l,url:"/api/upload",onSuccess:W,"before-upload":L,onFailure:H,name:"image"},{default:S(()=>[x(m(rt),{name:"image",size:"24"})]),_:1},512),x(T,{style:{"margin-left":"10px"},type:"primary",size:"small",icon:"",onClick:I},{icon:S(()=>[x(pe,{icon:"ion:paper-plane-outline"})]),default:S(()=>[F("发送 ")]),_:1})])]),_:1},8,["modelValue","onKeyup"])]),x(se,{visible:m(R),"onUpdate:visible":n[2]||(n[2]=r=>de(R)?R.value=r:null)},{default:S(()=>[Pa]),_:1},8,["visible"]),x(De,{visible:m(j),"onUpdate:visible":n[3]||(n[3]=r=>de(j)?j.value=r:null),"cancel-txt":"取消","menu-items":m(Ne),onChoose:ze},null,8,["visible","menu-items"])],64)}}});const Ya=ct(Aa,[["__scopeId","data-v-63de96dd"]]);export{Ya as default};
